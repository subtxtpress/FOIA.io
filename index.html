<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta property="og:title" content="FOIA.io — Request Management">
<meta property="og:description" content="Track, generate, and appeal public records requests">
<meta property="og:image" content="https://foiaio-production.up.railway.app/img/og-image.png">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://foiaio-production.up.railway.app/img/og-image.png">
<title>FOIA.io — Request Management</title>
<!-- Prevents phone number auto-detection formatting -->
<meta name="format-detection" content="telephone=no">

<!-- iOS: allows adding to home screen as standalone app -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FOIA.io">

<!-- Theme color for browser chrome (matches your --bg2) -->
<meta name="theme-color" content="#1e1e1e">

<!-- Prevents IE/Edge from using compatibility mode -->
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- SEO / social sharing -->
<meta name="description" content="FOIA Request Manager — track, generate, and appeal public records requests">
<meta name="robots" content="noindex, nofollow">
<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180.png">
<link rel="manifest" href="/manifest.json">
<!-- Security Headers -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
<meta name="referrer" content="strict-origin-when-cross-origin">
<!-- Performance -->
<link rel="preconnect" href="https://your-api-domain.com">
<style>
/* ── Dark mode (default) ───────────────────────────────────── */
:root {
  --bg:        #121212;
  --bg2:       #1e1e1e;
  --bg3:       #2a2a2a;
  --border:    #3a3a3a;
  --accent:    /*#BB86FC;*/#03DAC6;
  --accent-dim:#3700B3;
  --primary:   /*#BB86FC;*/#cccccc;
  --secondary: #03DAC6;
  --error:     #CF6679;
  --text:      #FFFFFF;
  --text-dim:  #B3B3B3;
  --on-primary:#000000;
  --on-secondary:#000000;
  --avatar-bg: #b3b3b3;
  --avatar-text:#000000;
  --cyan:      #03DAC6;
  --red:       #CF6679;
  --radius:    6px;
  --shadow:    0 2px 8px rgba(0,0,0,0.4);
  --shadow-lg: 0 10px 40px rgba(0,0,0,0.6);
  --font:      -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', system-ui, sans-serif;
}
/* ── Light mode ────────────────────────────────────────────── */
[data-theme="light"] {
  --bg:        #FFFFFF;
  --bg2:       #F5F5F5;
  --bg3:       #EEEEEE;
  --border:    #E0E0E0;
  --accent:    /*#BB86FC;*/#00897B;
  --accent-dim:#3700B3;
  --primary:   /*#BB86FC;*/#cccccc;
  --secondary: /*#03DAC6;*/#00897B;
  --error:     #B00020;
  --text:      #000000;
  --text-dim:  #757575;
  --on-primary:#000000;
  --on-secondary:#000000;
  --avatar-bg: #FFFFFF;
  --avatar-text:#000000;
  --cyan:      #00897B;
  --red:       #B00020;
  --shadow:    0 1px 4px rgba(0,0,0,0.08);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
}
/* ── Reset & Variables ─────────────────────────────────────── */
*,
*::before,
*::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}
html {
  overflow-x: clip;
  width: 100%;
}
body {
  overflow-x: clip;
  width: 100%;
  position: relative;
}
/* Additional body styles (overflow-x and width set in reset above) */
body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font);
  height: 100vh;
  height: 100dvh;
  line-height: 1.6;
  transition: background .25s, color .25s;
}
/* ── Layout ────────────────────────────────────────────────── */
#app {
  display: flex;
  min-height: 100vh;
  min-height: 100dvh;
  align-items: stretch;
  width: 100%;
  overflow-x: hidden;
}
/* Sidebar */
#sidebar {
  width: 240px;
  min-width: 240px;
  background: var(--bg2);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  position: sticky;
  top: 0;
  height: 100vh;
  height: 100dvh;
  overflow: hidden;
  transition: transform .3s;
  z-index: 100;
}
.sidebar-logo {
  padding: 24px 20px 16px;
  border-bottom: 1px solid var(--border);
}
.sidebar-logo h1 {
  font-size: 1.4rem; font-weight: 700;
  background: linear-gradient(90deg, #4d4d4d 0%, #d8d8d8 32.8%, #ffffff 52.4%, #d8d8d8 72.98%, #4d4d4d 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.8px;
  font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
}
.sidebar-logo p {
  font-size: .7rem;
  color: var(--text-dim);
  margin-top: 4px;
  letter-spacing: 0.3px;
  font-weight: 500;
}
.sidebar-nav-wrap {
  flex: 1;
  min-height: 0;
  position: relative;
}
.sidebar-nav-wrap::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 52px;
  background: linear-gradient(to bottom, transparent, var(--bg2));
  pointer-events: none;
  opacity: 1;
  transition: opacity .25s;
}
.sidebar-nav-wrap.at-bottom::after {
  opacity: 0;
}
.sidebar-nav {
  padding: 16px 12px;
  height: 100%;
  overflow-y: auto;
}
.nav-label {
  font-size: .65rem;
  font-weight: 700;
  color: var(--text-dim);
  letter-spacing: 1.2px;
  text-transform: uppercase;
  padding: 8px 8px 4px;
}
.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: .9rem;
  color: var(--text-dim);
  transition: all .15s;
  margin-bottom: 2px;
  border: none;
  background: none;
  width: 100%;
  text-align: left;
}
.nav-item:hover {
    background: var(--bg3);
    color: var(--text);
}
.nav-item.active {
  background: rgba(212,165,116,.12);
  color: var(--accent);
  font-weight: 600;
  border-left: 3px solid var(--accent);
  padding-left: 9px;
}
.nav-item .icon {
    font-size: 1.1rem;
    width: 20px;
    text-align: center;
    opacity: 0.7;
}
.nav-item.active .icon {
    opacity: 1;
}
.nav-item:hover .icon {
    opacity: 1;
}
.nav-badge {
  margin-left: auto;
  background: var(--cyan);
  color: var(--bg);
  font-size: .65rem;
  font-weight: 700;
  padding: 2px 7px;
  border-radius: 20px;
  min-width: 20px;
  text-align: center;
}
.nav-badge.red {
    background: var(--red);
    color: var(--bg);
}
.sidebar-footer {
  padding: 16px;
  border-top: 1px solid var(--border);
}
.user-pill {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--bg3);
  border-radius: 8px;
  padding: 10px 12px;
}
.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--avatar-bg);
  color: var(--avatar-text);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: .85rem;
  flex-shrink: 1;
}
.user-name {
    font-size: .85rem;
    font-weight: 600;
}
.user-status {
    font-size: .7rem;
    color: /*var(--green);*/#00897B;
}
#btnLogout {
  display: block;
  width: 100%;
  margin-top: 8px;
  background: none;
  border: 1px solid var(--border);
  color: var(--text-dim);
  padding: 7px;
  border-radius: 8px;
  cursor: pointer;
  font-size: .8rem;
  transition: all .15s;
}
#btnLogout:hover {
    border-color: var(--red);
    color: var(--red);
}
/* Sidebar footer */
#btnTheme {
  width:100%;
  background:var(--bg3);
  border:1px solid var(--border);
  color:var(--text);
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
  font-size:.82rem;
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:8px;
  transition: background .2s;
}
/* Main content */
#main {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
  max-width: 100%;
  overflow-x: hidden;
  overflow-y: auto;
  padding-left: 0;
  padding-right: 0;
}
.topbar {
  border-bottom: 1px solid var(--border);
  padding: 18px 40px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  position: sticky;
  top: 0;
  z-index: 50;
  backdrop-filter: blur(10px);
  background: var(--bg2);
}
.topbar-title {
  font-size: 1.15rem;
  font-weight: 600;
  letter-spacing: -0.3px;
  color: var(--text);
}
.hamburger {
  display: none;
  background: none;
  border: none;
  color: var(--text);
  font-size: 1.4rem;
  cursor: pointer;
  padding: 4px;
}
.content {
  padding: 20px 40px;
  max-width: 1800px;
  width: 100%;
  box-sizing: border-box;
}
/* ── Pages ─────────────────────────────────────────────────── */
.page {
  display: none;
}
.page.active {
  display: block;
  animation: fadeIn .15s ease;
}
.page > .card:first-child {
  margin-left: 0 !important;
}
#page-all-requests > .card,
#page-active-requests > .card,
#page-closed-requests > .card {
  margin-top: -12px;
}
.all-requests-card {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(6px);
  }
  to {
    opacity: 1;
    transform: none;
  }
}
/* ── Cards / Panels ────────────────────────────────────────── */
.card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow);
  max-width: 100%;
  overflow-x: hidden;
}
.card + .card {
  margin-top: 16px;
}
.card-title {
  font-size: .88rem;
  font-weight: 600;
  margin-bottom: 16px;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
/* ── Stats row ─────────────────────────────────────────────── */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 16px;
  margin-bottom: 28px;
}
.stat-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px 20px;
  text-align: center;
  box-shadow: var(--shadow);
  transition: transform 0.15s, box-shadow 0.15s;
}
.stat-card:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
.stat-num {
  font-size: 2.2rem;
  font-weight: 700;
  color: var(--text);
  letter-spacing: -1px;
  line-height: 1;
}
.stat-num.amber {
  color: var(--amber);
}
.stat-num.red {
  color: var(--red);
}
.stat-num.green {
  color: var(--green);
}
.stat-label {
  font-size: .75rem;
  color: var(--text-dim);
  margin-top: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
}
/* ── Tables ────────────────────────────────────────────────── */
.table-wrap {
  overflow-x: auto;
  border-radius: var(--radius);
}
table {
  width: 100%;
  border-collapse: collapse;
  background: var(--bg2);
  font-size: .875rem;
}
#agencyDirBody td, #agencyDirModal thead th {
  font-size: .7rem;
}
thead th {
  background: var(--bg3);
  padding: 14px 16px;
  text-align: left;
  font-size: .7rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-dim);
  border-bottom: 2px solid var(--border);
  white-space: nowrap;
}
tbody tr {
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: all .15s;
}
tbody tr:hover {
  background: var(--bg3);
  transform: translateX(2px);
}
tbody tr:last-child {
  border-bottom: none;
}
td {
  padding: 13px 16px;
}
.td-number {
  font-family: monospace;
  color: var(--cyan);
  font-size: .8rem;
  font-weight: 700;
  white-space: nowrap;
}
.td-subject {
  font-weight: 600;
}
.td-agency {
  color: var(--text-dim);
  font-size: .85rem;
}
/* ── Badges ────────────────────────────────────────────────── */
.badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 20px;
  font-size: .72rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .5px;
}
.badge-new {
  background: rgba(3,218,198,.12);
  color: var(--secondary);
}
.badge-active {
  background: rgba(3,218,198,.15);
  color: var(--secondary);
}
.badge-overdue {
  background: rgba(207,102,121,.15);
  color: var(--error);
}
.badge-closed {
  background: rgba(3,218,198,.15);
  color: var(--secondary);
}
.badge-appealed {
  background: rgba(187,134,252,.15);
  color: var(--primary);
}
.badge-myturn {
  background: rgba(3,218,198,.15);
  color: var(--secondary);
}
.badge-theirturn {
  background: rgba(187,134,252,.15);
  color: var(--primary);
}
/* ── Buttons ───────────────────────────────────────────────── */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 10px 20px;
  border-radius: 8px;
  font-size: .875rem;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: all .15s;
  white-space: nowrap;
}
.btn-primary {
  background: var(--primary);
  color: var(--on-primary);
  border: 1px solid var(--primary);
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(98,0,238,0.2);
  transition: all 0.2s;
}
.btn-primary:hover {
  background: linear-gradient(90deg, #4d4d4d 0%, #d8d8d8 32.8%, #ffffff 52.4%, #d8d8d8 72.98%, #4d4d4d 100%);
  border-color: #d8d8d8;
  color: #000000;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(77,77,77,0.4);
}
.btn-ghost {
  background: none;
  border: 1px solid var(--border);
  color: var(--text-dim);
}
.btn-ghost:hover {
  border-color: var(--accent);
  color: var(--accent);
}
.btn-danger {
  background: none;
  border: 1px solid var(--border);
  color: var(--red);
}
.btn-danger:hover {
  background: rgba(231,76,60,.1);
  border-color: var(--red);
}
.btn-sm {
  padding: 5px 10px;
  font-size: .75rem;
}
.btn-icon {
  padding: 8px;
  border-radius: 6px;
}
#btnDownloadDocx {
  display: none;
}
.regenerate-btn {
  margin-left: 8px;
}
/* ── Forms ─────────────────────────────────────────────────── */
.form-group {
  margin-bottom: 18px;
}
label {
  display: block;
  font-size: .8rem;
  font-weight: 600;
  color: var(--text-dim);
  margin-bottom: 6px;
}
input,
select,
textarea {
  width: 100%;
  background: var(--bg3);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 12px 14px;
  border-radius: 6px;
  font-size: .9rem;
  font-family: var(--font);
  transition: all .2s;
  outline: none;
}
input:focus,
select:focus,
textarea:focus {
  border-color: var(--text-dim);
  background: var(--bg2);
  box-shadow: 0 0 0 3px rgba(255,255,255,.05);
}
select {
  padding-right: 32px;
}
select option {
  background: var(--bg3);
}
textarea {
  resize: vertical;
  min-height: 100px;
}
.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}
.form-info {
  background: var(--bg3);
  border-radius: 8px;
  padding: 14px 16px;
  font-size: .85rem;
  line-height: 1.8;
}
.form-info .info-label {
  color: var(--text-dim);
  font-size: .75rem;
}
.form-info .info-val {
  color: var(--text);
  font-weight: 500;
}
.form-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 24px;
  padding-top: 20px;
  border-top: 1px solid var(--border);
}
/* ── Auth pages ────────────────────────────────────────────── */
#authWrap {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg);
  padding: 20px;
}
.auth-box {
  width: 100%;
  max-width: 420px;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 48px 40px;
  box-shadow: var(--shadow-lg);
}
.auth-logo {
  text-align: center;
  margin-bottom: 40px;
  padding-bottom: 24px;
  border-bottom: 1px solid var(--border);
}
.auth-logo h1 {
  font-size: 1.8rem;
  font-weight: 700;
  letter-spacing: -1px;
  margin-bottom: 8px;
  font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
  display: inline-block;
  background: linear-gradient(45deg, #4d4d4d 0%, #d8d8d8 32.8%, #ffffff 52.4%, #d8d8d8 72.98%, #4d4d4d 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  color: transparent;
}
.auth-logo p {
  color: var(--text-dim);
  font-size: .85rem;
  margin-top: 4px;
  letter-spacing: 0.3px;
  font-weight: 500;
}
.auth-tabs {
  display: flex;
  background: var(--bg3);
  border-radius: 8px;
  padding: 4px;
  margin-bottom: 28px;
  gap: 4px;
  border: 1px solid var(--border);
}
.auth-tab {
  flex: 1;
  text-align: center;
  padding: 9px 8px;
  border-radius: 6px;
  cursor: pointer;
  font-size: .875rem;
  font-weight: 600;
  color: var(--text-dim);
  transition: all .15s;
  border: none;
  background: none;
}
.auth-tab.active {
  background: var(--bg2);
  color: var(--text);
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.auth-tab:not(.active):hover {
  color: var(--text);
}
.auth-submit {
  width: 100%;
  margin-top: 8px;
  justify-content: center;
  background: linear-gradient(90deg, #4d4d4d 0%, #d8d8d8 32.8%, #ffffff 52.4%, #d8d8d8 72.98%, #4d4d4d 100%);
  color: #000000;
  border: 1px solid #d8d8d8;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(77,77,77,0.3);
  transition: all 0.2s;
}
.auth-submit:hover {
  background: linear-gradient(90deg, #3d3d3d 0%, #c8c8c8 32.8%, #f0f0f0 52.4%, #c8c8c8 72.98%, #3d3d3d 100%);
  border-color: #c8c8c8;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(77,77,77,0.4);
}
.auth-error {
  background: rgba(231,76,60,.08);
  border: 1px solid rgba(231,76,60,.3);
  color: var(--red);
  padding: 12px 16px;
  border-radius: 6px;
  font-size: .85rem;
  margin-bottom: 16px;
  display: none;
  font-weight: 500;
}
/* ── Modal ─────────────────────────────────────────────────── */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.85);
  z-index: 500;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  opacity: 0;
  pointer-events: none;
  transition: opacity .2s;
  overflow: hidden;
}
.modal-overlay.open {
  opacity: 1;
  pointer-events: all;
}
.modal {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 14px;
  width: 100%;
  max-width: 720px;
  max-height: 90vh;
  max-height: 90dvh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transform: translateY(20px);
  transition: transform .2s;
  box-shadow: var(--shadow);
}
.modal-overlay.open .modal {
  transform: translateY(0);
}
.modal-header {
  padding: 24px 28px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  position: sticky;
  top: 0;
  background: var(--bg2);
  z-index: 1;
}
.modal-header h2 {
  font-size: 1.1rem;
  font-weight: 700;
}
.modal-close {
  background: none;
  border: none;
  color: var(--text-dim);
  font-size: 1.4rem;
  cursor: pointer;
  line-height: 1;
  padding: 4px;
}
.modal-close:hover {
  color: var(--text);
}
.modal-body {
  padding: 24px 28px;
  overflow-y: auto;
  overflow-x: hidden;
  overflow-wrap: break-word;
  word-break: break-word;
  flex: 1;
  min-height: 0;
}
/* Letter modal specifics */
.request-letter-modal {
  font-size: .8rem;
  color: var(--text-dim);
  margin-top: 4px;
}
.letter-pre {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 20px;
  white-space: pre-wrap;
  font-family: 'Georgia', serif;
  font-size: .88rem;
  line-height: 1.9;
  color: var(--text);
  min-height: 300px;
  outline: none;
}
.letter-pre:focus {
  border-color: var(--cyan);
}
.copy-row {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-top: 12px;
  flex-wrap: wrap;
}
.copy-success {
  color: var(--green);
  font-size: .8rem;
  display: none;
}
#foiaGovLink {
  margin-left: auto;
}
.discard-save {
  margin-top: 20px;
  position: sticky;
  bottom: 0;
  background: var(--bg2);
  padding-bottom: 8px;
  padding-top: 12px;
  margin-left: -28px;
  margin-right: -28px;
  padding-left: 28px;
  padding-right: 28px;
  border-top: 1px solid var(--border);
}
.modal-body > .form-actions:last-child {
  position: sticky;
  bottom: 0;
  background: var(--bg2);
  padding-bottom: 8px;
  margin-left: -28px;
  margin-right: -28px;
  padding-left: 28px;
  padding-right: 28px;
}
/* ── Agency auto-fill panel ────────────────────────────────── */
.agency-info-panel {
  display: none;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  margin-top: 12px;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
.agency-info-panel.visible {
  display: grid;
}
.ai-field { 

}
#aipPortalLink {
  color: var(--cyan);
  font-size: .85rem;
}
.ai-field .ai-label {
  font-size: .7rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: .6px;
}
.ai-field .ai-val {
  font-size: .85rem;
  color: var(--text);
  margin-top: 2px;
  font-weight: 500;
}
.ai-field.full {
  grid-column: 1 / -1;
}
/* ── Detail panel ──────────────────────────────────────────── */
#backButton {
  margin-left: 5%;
}
#detailContent {
  padding: 5%;
  margin: 0;
}
.detail-header {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 20px;
}
.detail-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 10px;
}
.meta-chip {
  background: var(--bg3);
  border-radius: 6px;
  padding: 4px 10px;
  font-size: .72rem;
  color: var(--text-dim);
}
.meta-chip strong {
  color: var(--text); 
}
.deadline-banner {
  border-radius: 6px;
  padding: 10px 14px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
  font-size: .82rem;
}
.deadline-banner.ok {
  background: rgba(39,174,96,.08);
  border: 1px solid rgba(39,174,96,.3);
  color: var(--green);
}
.deadline-banner.warn {
  background: rgba(243,156,18,.08);
  border: 1px solid rgba(243,156,18,.3);
  color: var(--amber);
}
.deadline-banner.over {
  background: rgba(231,76,60,.08);
  border: 1px solid rgba(231,76,60,.3);
  color: var(--red);
}
.action-log-list {
  list-style: none;
}
.action-log-list li {
  display: flex;
  gap: 12px;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
  font-size: .85rem;
}
.action-log-list li:last-child {
  border-bottom: none;
}
.al-date {
  color: var(--text-dim);
  font-size: .78rem;
  white-space: nowrap;
}
.al-action {
  color: var(--text);
  font-weight: 500;
}
.al-note {
  color: var(--text-dim);
  font-size: .8rem;
}
/* –– Administrative Appeals –––––––––––––––––––––––––––––––––– */
#appealModalSub {
  font-size: .8rem;
  color: var(--text-dim);
  margin-top: 4px;
}
.appeal-type {
  margin-bottom: 16px;
}
.copy-to-clipboard {
  margin-top: 12px;
}
/* ── Alert / Toast ─────────────────────────────────────────── */
#toast {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 9999;
  background: var(--bg3);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 12px 20px;
  border-radius: 10px;
  font-size: .88rem;
  font-weight: 500;
  box-shadow: var(--shadow);
  transform: translateY(80px);
  opacity: 0;
  transition: all .25s;
  max-width: 340px;
}
#toast.show {
  transform: translateY(0);
  opacity: 1;
}
#toast.success {
  border-color: var(--green);
  color: var(--green);
}
#toast.error {
  border-color: var(--red);
  color: var(--red);
}
/* ── Pricing page ──────────────────────────────────────────── */
.pricing-tiers {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-bottom: 32px;
}
@media (max-width: 768px) {
  .pricing-tiers {
    grid-template-columns: 1fr;
  }
  .hide-mobile {
    display: none;
  }
}
/* ── Subscribe page ────────────────────────────────────────── */
.subscribe-card {
  max-width: 480px;
  margin: 60px auto;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 40px;
  text-align: center;
}
.subscribe-card h2 {
  font-size: 1.6rem;
  font-weight: 800;
  margin-bottom: 12px;
}
.subscribe-card p {
  color: var(--text-dim);
  margin-bottom: 24px;
}
.price-tag {
  font-size: 2.5rem;
  font-weight: 800;
  color: var(--cyan);
  margin: 24px 0 8px;
}
.price-tag span {
  font-size: 1rem;
  font-weight: 400;
  color: var(--text-dim);
}
.feature-list {
  list-style: none;
  text-align: left;
  margin: 24px 0;
  padding: 20px;
  background: var(--bg3);
  border-radius: 10px;
}
.feature-list li {
  padding: 6px 0;
  color: var(--text-dim);
  font-size: .9rem;
  display: flex;
  gap: 8px;
}
.feature-list li::before {
  content: "✓";
  color: var(--green);
  font-weight: 700;
}
/* ── Empty states ──────────────────────────────────────────── */
#stateSection {
  display: none;
}
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-dim);
}
.empty-state .e-icon {
  font-size: 3rem;
  margin-bottom: 16px;
  opacity: 0.3; font-weight: 300;
}
.empty-state h3 {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 8px;
}
.empty-state p {
  font-size: .9rem;
  max-width: 360px;
  margin: 0 auto 20px;
}
#stateLawPanel {
  display: none;
  background:var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
}
.stateLawPanel-1 {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap:12px;
}
.stateLawPanel-2 {
  font-size: .7rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: .6px;
}
#slLawName {
  font-size: .85rem;
  font-weight: 600;
  margin-top: 2px;
}
.stateLawPanel-3 {
  font-size: .7rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: .6px;
}
#slCitation {
  font-size: .85rem;
  font-weight: 600;
  margin-top: 2px;
  color: var(--cyan);
}
.stateLawPanel-4 {
  font-size: .7rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: .6px;
}
#slDays {
  font-size: .85rem;
  font-weight: 600;
  margin-top: 2px;
}
.stateLawPanel-5 {
  margin-top:10px;
}
.stateLawPanel-6 {
  font-size: .7rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: .6px;
}
#slNotes {
  font-size: .82rem;
  color: var(--text-dim);
  margin-top: 2px;
}
/* ── Responsive ────────────────────────────────────────────── */
@media (max-width: 480px) {
  #sidebarOverlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.5);
    z-index: 90;
  }
  .stats-grid {
    grid-template-columns: 1fr 1fr;
  }
}
@media (max-width: 768px) {
  html, body {
    overflow-x: clip;
    width: 100%;
    max-width: 100%;
  }
  #app {
    width: 100%;
    max-width: 100%;
  }
  #sidebar {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    transform: translateX(-100%);
    width: 240px;
    min-width: 0;
    max-width: 240px;
  }
  #sidebar.open {
    transform: translateX(0);
  }
  .hamburger {
    display: block;
  }
  #main {
    padding-left: 0;
    padding-right: 0;
    width: 100%;
    max-width: 100%;
  }
  .content {
    padding: 20px 16px;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }
  .topbar {
    padding: 12px 16px;
    gap: 8px;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    margin: 0;
  }
  .topbar-title {
    font-size: 1rem;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    min-width: 0;
  }
  .topbar .btn-sm {
    font-size: 0.75rem;
    padding: 6px 12px;
    flex-shrink: 0;
    width: auto;
  }
  .page {
    max-width: 100%;
    box-sizing: border-box;
  }
  .card {
    padding: 12px;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    margin-left: 0;
    margin-right: 0;
  }
  .table-wrap {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    max-width: 100%;
    width: 100%;
    box-sizing: border-box;
  }
  table {
    max-width: 100%;
    width: 100%;
  }
  .form-row {
    grid-template-columns: 1fr;
    gap: 12px;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }
  .modal {
    max-width: 100%;
    max-height: 88vh;
    max-height: 88dvh;
    border-radius: 12px 12px 0 0;
    width: 100%;
    box-sizing: border-box;
  }
  .modal-overlay {
    align-items: flex-end;
    padding: 0;
  }
  .modal-header {
    padding: 12px 16px 10px;
    box-sizing: border-box;
    width: 100%;
    max-width: 100%;
  }
  .modal-header h2 {
    font-size: .88rem;
  }
  .modal-header .request-letter-modal,
  .modal-header #appealModalSub {
    font-size: .72rem;
  }
  .modal-body {
    padding: 12px 16px;
    box-sizing: border-box;
    width: 100%;
    max-width: 100%;
  }
  .discard-save,
  .modal-body > .form-actions:last-child {
    margin-left: -20px;
    margin-right: -20px;
    padding-left: 20px;
    padding-right: 20px;
  }
  .letter-pre {
    padding: 12px;
    min-height: 200px;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }
  .filter-row input,
  .filter-row select {
    padding: 8px 10px;
    font-size: .82rem;
  }
  .filter-row select {
    padding-right: 28px;
  }
  .form-group {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    margin-bottom: 14px;
  }
  input,
  select,
  textarea {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    font-size: 1rem; /* Prevent iOS Safari auto-zoom (triggers below 16px) */
  }
  label {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }
  .btn {
    box-sizing: border-box;
  }
  .copy-row {
    max-width: 100%;
    box-sizing: border-box;
  }
  .form-info {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }
  .agency-info-panel {
    grid-template-columns: 1fr;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }
  .detail-header {
    flex-direction: column;
    width: 100%;
    max-width: 100%;
  }
  .detail-actions {
    width: 100%;
    flex-direction: column;
  }
  .detail-actions .btn {
    width: 100%;
    justify-content: center;
  }
  .detail-grid {
    grid-template-columns: 1fr !important;
  }
  .form-actions {
    flex-direction: column;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }
  .form-actions .btn {
    width: 100%;
    justify-content: center;
  }
  .stats-grid {
    grid-template-columns: 1fr 1fr;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }
  .stat-card {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    padding: 16px 12px;
  }
  .stat-num {
    font-size: 1.8rem;
  }
  .badge {
    max-width: 100%;
    box-sizing: border-box;
  }
  .meta-chip {
    max-width: 100%;
    box-sizing: border-box;
  }
  .deadline-banner {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    padding: 12px 14px;
  }
  .action-log-list {
    width: 100%;
    max-width: 100%;
  }
  .action-log-list li {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    flex-wrap: wrap;
  }
  .detail-meta {
    width: 100%;
    max-width: 100%;
  }
  #toast {
    right: 16px;
    bottom: 16px;
    left: 16px;
    max-width: calc(100% - 32px);
  }
  .subscribe-card {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    padding: 28px 20px;
  }
  .auth-box {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    padding: 32px 24px;
  }
  .card-title {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }
  h2, h3 {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }
  /* Sidebar spacing reductions */
  .sidebar-logo {
    padding: 16px 16px 12px;
  }
  .sidebar-logo h1 {
    font-size: 1.2rem;
  }
  .sidebar-logo p {
    font-size: 0.65rem;
  }
  .sidebar-nav {
    padding: 12px 8px;
    overflow-y: auto;
  }
  .nav-label {
    padding: 6px 6px 3px;
    font-size: 0.6rem;
    margin-top: 2px;
  }
  .nav-item {
    padding: 8px 10px;
    gap: 8px;
    margin-bottom: 1px;
  }
  .nav-item.active {
    padding-left: 7px;
    border-left: 2px solid var(--accent);
  }
  .nav-item .icon {
    width: 18px;
    font-size: 1rem;
  }
  .nav-badge {
    padding: 2px 6px;
    font-size: 0.6rem;
    min-width: 18px;
  }
  .sidebar-footer {
    padding: 12px;
  }
  .user-pill {
    padding: 8px 10px;
    gap: 8px;
  }
  .user-avatar {
    width: 28px;
    height: 28px;
    font-size: 0.75rem;
  }
  .user-name {
    font-size: 0.8rem;
  }
  #btnLogout {
    margin-top: 6px;
    padding: 6px;
    font-size: 0.75rem;
  }
  /* Card spacing */
  .card + .card {
    margin-top: 12px;
  }
  .card-title {
    margin-bottom: 14px;
    gap: 6px;
    font-size: 0.85rem;
  }
  /* Stats refinements */
  .stats-grid {
    gap: 12px;
    margin-bottom: 20px;
  }
  .stat-card {
    padding: 16px 14px;
  }
  .stat-num {
    font-size: 1.8rem;
  }
  .stat-label {
    font-size: 0.7rem;
    margin-top: 6px;
  }
  /* Table spacing */
  thead th {
    padding: 10px 12px;
    font-size: 0.65rem;
  }
  tbody tr:hover {
    transform: none;
  }
  td {
    padding: 10px 12px;
    font-size: 0.825rem;
  }
  .td-number {
    font-size: 0.75rem;
  }
  .td-agency {
    font-size: 0.8rem;
  }
  /* Badge refinements */
  .badge {
    padding: 2px 8px;
    font-size: 0.68rem;
  }
  /* Button refinements */
  .btn {
    padding: 8px 16px;
    gap: 5px;
    font-size: 0.825rem;
  }
  .btn-icon {
    padding: 6px;
  }
  /* Auth page spacing */
  #authWrap {
    padding: 16px;
  }
  .auth-logo {
    margin-bottom: 28px;
    padding-bottom: 20px;
  }
  .auth-logo h1 {
    font-size: 1.5rem;
    margin-bottom: 6px;
  }
  .auth-logo p {
    font-size: 0.8rem;
    margin-top: 3px;
  }
  .auth-tabs {
    padding: 3px;
    margin-bottom: 20px;
    gap: 3px;
  }
  .auth-tab {
    padding: 6px;
    font-size: 0.825rem;
  }
  .auth-error {
    padding: 10px 14px;
    margin-bottom: 14px;
    font-size: 0.8rem;
  }
  /* Modal refinements */
  .modal-header h2 {
    font-size: 1rem;
  }
  .modal-close {
    padding: 8px;
    font-size: 1.5rem;
  }
  /* Form element refinements */
  .copy-row {
    gap: 8px;
    margin-top: 10px;
  }
  .agency-info-panel {
    padding: 12px;
    margin-top: 10px;
    gap: 8px;
  }
  .ai-field .ai-label {
    font-size: 0.65rem;
  }
  .ai-field .ai-val {
    font-size: 0.8rem;
  }
  /* Detail refinements */
  .detail-header {
    gap: 8px;
    margin-bottom: 16px;
  }
  .detail-meta {
    gap: 6px;
    margin-top: 8px;
  }
  .meta-chip {
    padding: 3px 8px;
    font-size: 0.7rem;
  }
  .deadline-banner {
    gap: 8px;
    margin-bottom: 14px;
    font-size: 0.8rem;
    padding: 8px 12px;
  }
  .action-log-list li {
    gap: 10px;
    padding: 8px 0;
  }
  .al-date {
    font-size: 0.75rem;
  }
  .al-action {
    font-size: 0.8rem;
  }
  .al-note {
    font-size: 0.75rem;
  }
  /* Subscribe page refinements */
  .subscribe-card {
    margin: 40px auto 20px;
  }
  .subscribe-card h2 {
    font-size: 1.3rem;
    margin-bottom: 10px;
  }
  .subscribe-card p {
    margin-bottom: 18px;
    font-size: 0.85rem;
  }
  .price-tag {
    font-size: 2rem;
    margin: 18px 0 6px;
  }
  .price-tag span {
    font-size: 0.9rem;
  }
  .feature-list {
    margin: 18px 0;
    padding: 16px;
  }
  .feature-list li {
    padding: 5px 0;
    gap: 6px;
    font-size: 0.85rem;
  }
  /* Empty state refinements */
  .empty-state {
    padding: 40px 16px;
    display: none;
  }
  .empty-state .e-icon {
    font-size: 2.5rem;
    margin-bottom: 12px;
  }
  .empty-state h3 {
    font-size: 1rem;
    margin-bottom: 6px;
  }
  .empty-state p {
    font-size: 0.85rem;
    max-width: 100%;
    margin: 0 auto 16px;
  }
}
/* ── Extra-small screens (≤360px) ─────────────────────────── */
@media (max-width: 360px) {
  .content {
    padding: 12px 8px;
  }
  .topbar {
    padding: 10px 8px;
  }
  .card {
    padding: 10px 8px;
  }
  .stats-grid {
    grid-template-columns: 1fr;
  }
  .stat-num {
    font-size: 1.5rem;
  }
  .stat-label {
    font-size: .65rem;
  }
  .auth-box {
    padding: 24px 16px;
  }
  .btn {
    padding: 8px 12px;
    font-size: .8rem;
  }
  .form-actions {
    gap: 8px;
  }
  .nav-item {
    padding: 7px 8px;
    font-size: .82rem;
  }
  select, input, textarea {
    font-size: .82rem;
    padding: 10px 10px;
  }
  .filter-row {
    flex-direction: column;
    gap: 6px;
  }
  .filter-row select {
    flex: 1;
    width: auto;
  }
  .modal {
    border-radius: 8px 8px 0 0;
    max-height: 92dvh;
  }
  .modal-body {
    padding: 10px 14px;
  }
  .modal-header {
    padding: 10px 14px 8px;
  }
  .sidebar-footer {
    padding: 8px 10px;
  }
  .user-pill {
    padding: 7px 9px;
  }
  #btnLogout {
    padding: 5px;
    font-size: .72rem;
    margin-top: 6px;
  }
  .discard-save,
  .modal-body > .form-actions:last-child {
    margin-left: -16px;
    margin-right: -16px;
    padding-left: 16px;
    padding-right: 16px;
  }
}
/* ── Wide screens (≥1400px) ───────────────────────────────── */
@media (min-width: 1400px) {
  .content {
    max-width: 1800px;
    padding: 28px 60px;
  }
  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }
}
/* –– Subscribe Page ────────────────────────────────────────────── */
#subscribePage {
  display: none;
  position: fixed;
  inset: 0;
  background: var(--bg);
  z-index: 999;
  overflow-y: auto;
}
.stripe-btn {
  width: 100%;
  justify-content: center;
  font-size: 1rem;
  padding: 14px;
}
.activate-free-trial {
  margin-top: 12px;
  font-size: .8rem;
  color: var(--text-dim);
}
.dev-access {
  width: 100%;
  justify-content: center;
  margin-top: 8px;
}

.copy-ref-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--text-dim);
  border-radius: 4px;
  padding: 3px 7px;
  font-size: .8rem;
  cursor: pointer;
  transition: all .15s;
  white-space: nowrap;
}
.copy-ref-btn:hover {
  border-color: var(--cyan);
  color: var(--cyan);
}
.copy-ref-btn.copied {
  border-color: var(--cyan);
  color: var(--cyan);
}
</style>
</head>
<body>

<!-- ── Auth Screen ─────────────────────────────────────────── -->
<div id="authWrap">
  <div class="auth-box">
    <div class="auth-logo">
      <h1>FOIA.io</h1>
      <p>FOIA Request Management</p>
    </div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="authTab('login')">Sign In</button>
      <button class="auth-tab" onclick="authTab('register')">Create Account</button>
    </div>
    <div id="authError" class="auth-error"></div>

    <!-- Login -->
    <div id="loginForm">
      <div class="form-group">
        <label>Username or Email</label>
        <input type="text" id="loginUser" placeholder="your@email.com" autocomplete="username">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="loginPass" placeholder="••••••••" autocomplete="current-password">
      </div>
      <button class="btn auth-submit" onclick="doLogin()">Sign In</button>
    </div>

    <!-- Register -->
    <div id="registerForm" style="display:none;">
      <div class="form-group">
        <label>Username</label>
        <input type="text" id="regUser" placeholder="journaliststeve" autocomplete="username">
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="regEmail" placeholder="you@press.org" autocomplete="email">
      </div>
      <div class="form-group">
        <label>Password <small style="color:var(--text-dim)">(min 8 characters)</small></label>
        <input type="password" id="regPass" placeholder="••••••••" autocomplete="new-password">
      </div>
      <div class="form-group">
        <label>Invite Code <small style="color:var(--text-dim)">(optional)</small></label>
        <input type="text" id="regInvite" placeholder="AEOD-XXXXXXXX" autocomplete="off" style="text-transform:uppercase;letter-spacing:.5px;">
      </div>
      <button class="btn auth-submit" onclick="doRegister()">Create Account</button>
    </div>
  </div>
</div>

<!-- ── Main App ────────────────────────────────────────────── -->
<div id="app" style="display:none;">

  <!-- Sidebar overlay (mobile) -->
  <div id="sidebarOverlay" onclick="closeSidebar()"></div>

  <!-- Sidebar -->
  <nav id="sidebar">
    <div class="sidebar-logo">
      <h1>FOIA.io</h1>
      <p>Request Manager</p>
    </div>
    <div class="sidebar-nav-wrap">
    <div class="sidebar-nav" id="sidebarNav">
      <div class="nav-label">Overview</div>
      <button class="nav-item active" data-page="dashboard" onclick="nav('dashboard')">
        <span class="icon">△</span> Dashboard
      </button>

      <div class="nav-label">Requests</div>
      <button class="nav-item" data-page="new-request" onclick="nav('new-request')">
        <span class="icon">﹢</span> New Request
      </button>
      <button class="nav-item" data-page="all-requests" onclick="nav('all-requests')">
        <span class="icon">≡</span> All Requests
        <span class="nav-badge" id="badgeAll" style="background:var(--bg3);color:var(--text-dim);">0</span>
      </button>
      <button class="nav-item" data-page="active-requests" onclick="nav('active-requests')">
        <span class="icon">⍛</span> Active Requests
        <span class="nav-badge" id="badgeActive" style="background:var(--bg3);color:var(--text-dim);">0</span>
      </button>
      <button class="nav-item" data-page="closed-requests" onclick="nav('closed-requests')">
        <span class="icon">☑︎</span> Closed Requests
        <span class="nav-badge" id="badgeClosed" style="background:var(--bg3);color:var(--text-dim);">0</span>
      </button>

      <div class="nav-label" id="adminNavSection" style="display:none;">Admin</div>
      <button class="nav-item" id="adminNavBtn" data-page="admin" onclick="nav('admin')" style="display:none;">
        <span class="icon">⚙</span> Invite Codes
      </button>

      <div class="nav-label">Reference</div>
      <button class="nav-item" onclick="openAgencyModal()">
        <span class="icon">⚖︎</span> Federal Agencies
      </button>
      <button class="nav-item" onclick="openStateLawsModal()">
        <span class="icon">⚖︎</span> State Laws
      </button>
      <button class="nav-item" onclick="openLawEnforcementModal()">
        <span class="icon">✭</span> State & Local Agencies
      </button>
    </div>
    </div><!-- /.sidebar-nav-wrap -->
    <div class="sidebar-footer">
      <button id="btnTheme" onclick="toggleTheme()">
        <span id="themeIcon">☼</span>
        <span id="themeLabel">Light Mode</span>
      </button>
      <div class="user-pill">
        <div class="user-avatar" id="userAvatar">?</div>
        <div>
          <div class="user-name" id="userName">Loading…</div>
          <div class="user-status" id="userStatus">● Active</div>
        </div>
      </div>
      <button id="btnLogout" onclick="doLogout()">Sign Out</button>
      <div style="display:flex;gap:8px;margin-top:4px;padding-top:4px;border-top:1px solid var(--border);align-items:center;flex-wrap:wrap;justify-content:center;">
        <button onclick="nav('help')" style="background:none;border:none;color:var(--text-dim);font-size:.72rem;cursor:pointer;padding:0;">Help</button>
        <span style="color:var(--border);font-size:.72rem;">·</span>
        <button onclick="nav('terms')" style="background:none;border:none;color:var(--text-dim);font-size:.72rem;cursor:pointer;padding:0;">Terms</button>
        <span style="color:var(--border);font-size:.72rem;">·</span>
        <button onclick="nav('pricing')" style="background:none;border:none;color:var(--text-dim);font-size:.72rem;cursor:pointer;padding:0;">Plans</button>
        <span style="color:var(--border);font-size:.72rem;">·</span>
        <button onclick="document.getElementById('betaModal').classList.add('open')" style="background:none;border:none;color:var(--cyan);font-size:.72rem;cursor:pointer;padding:0;font-weight:600;letter-spacing:.3px;">BETA</button>
      </div>
    </div>
  </nav>

  <!-- Main content -->
  <div id="main">
    <div class="topbar">
      <button class="hamburger" onclick="toggleSidebar()">☰</button>
      <div class="topbar-title" id="topbarTitle">Dashboard</div>
      <button class="btn btn-primary btn-sm" id="topbar-btn" onclick="nav('new-request')">+ New Request</button>
    </div>

    <div class="content">

      <!-- ── Dashboard ──────────────────────────────────────── -->
      <div id="page-dashboard" class="page active">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-num" id="statTotal">–</div>
            <div class="stat-label">Total Requests</div>
          </div>
          <div class="stat-card">
            <div class="stat-num amber" id="statActive">–</div>
            <div class="stat-label">Active</div>
          </div>
          <div class="stat-card">
            <div class="stat-num red" id="statOverdue">–</div>
            <div class="stat-label">Overdue</div>
          </div>
          <div class="stat-card">
            <div class="stat-num green" id="statClosed">–</div>
            <div class="stat-label">Closed</div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Recently Active</div>
          <div id="dashRecentList"></div>
        </div>

        <div class="card" style="margin-top:16px;">
          <div class="card-title">Overdue Deadlines</div>
          <div id="dashOverdueList"></div>
        </div>
      </div>

      <!-- ── New Request ────────────────────────────────────── -->
      <div id="page-new-request" class="page">
        <div class="card">
          <div class="card-title">﹢ New FOIA Request</div>

          <div class="form-row">
            <div class="form-group">
              <label>FOIA Number (auto-generated)</label>
              <input type="text" id="nrFoiaNum" readonly style="opacity:.6;cursor:default;">
            </div>
            <div class="form-group">
              <label>Filed Date</label>
              <input type="date" id="nrDate" title="Change this if you're entering an older request">
            </div>
          </div>

          <div class="form-group">
            <label>Jurisdiction</label>
            <select id="nrType" onchange="onTypeChange()">
              <option value="">— Select jurisdiction —</option>
              <option value="Federal">Federal</option>
              <option value="State">State</option>
              <option value="Local">Local</option>
              <option value="University">University</option>
              <option value="Other">Other (enter manually)</option>
            </select>
          </div>

          <!-- Manual jurisdiction (shown for "Other") -->
          <div id="manualJurisdictionSection" style="display:none;">
            <div class="form-group">
              <label>Jurisdiction Name</label>
              <input type="text" id="nrManualJurisdiction" placeholder="e.g. Tribal, Military, International…">
            </div>
            <div class="form-group">
              <label>Agency / Entity Name</label>
              <input type="text" id="nrManualAgency" placeholder="e.g. Navajo Nation FOIA Office…">
            </div>
          </div>

          <div id="federalAgencySection" style="display:none;">
            <div class="form-group">
              <label>Federal Agency</label>
              <select id="nrAgency" onchange="onAgencyChange()">
                <option value="">— Select agency —</option>
              </select>
            </div>
            <div id="federalManualEntry" style="display:none;">
              <div class="form-group">
                <label>Agency Name (not in list)</label>
                <input type="text" id="nrFedManualAgency" placeholder="e.g. Office of Special Counsel…">
              </div>
            </div>
            <div class="agency-info-panel" id="agencyInfoPanel">
              <div class="ai-field">
                <div class="ai-label">FOIA Officer Title</div>
                <div class="ai-val" id="aipTitle">—</div>
              </div>
              <div class="ai-field">
                <div class="ai-label">Email</div>
                <div class="ai-val" id="aipEmail">—</div>
              </div>
              <div class="ai-field">
                <div class="ai-label">Phone</div>
                <div class="ai-val" id="aipPhone">—</div>
              </div>
              <div class="ai-field">
                <div class="ai-label">Fax</div>
                <div class="ai-val" id="aipFax">—</div>
              </div>
              <div class="ai-field full">
                <div class="ai-label">Mailing Address</div>
                <div class="ai-val" id="aipAddress" style="white-space:pre-line;">—</div>
              </div>
              <div class="ai-field full" id="aipPortalRow" style="display:none;">
                <div class="ai-label">Online Portal</div>
                <div class="ai-val">
                  <a id="aipPortalLink" href="#" target="_blank" rel="noopener">🌐 Open Agency FOIA Portal →</a>
                </div>
              </div>
            </div>
          </div>

          <!-- Local / University section -->
          <div id="localUnivSection" style="display:none;">
            <div class="form-row">
              <div class="form-group">
                <label>State (optional)</label>
                <select id="nrLocalState">
                  <option value="">— Select state —</option>
                </select>
              </div>
              <div class="form-group">
                <label id="localUnivAgencyLabel">Agency / Institution Name</label>
                <input type="text" id="nrLocalAgency" placeholder="e.g. Austin Police Department, UT Austin…">
              </div>
            </div>
          </div>

          <!-- State section -->
          <div id="stateSection" style="display:none;">
            <div class="form-row">
              <div class="form-group">
                <label>State</label>
                <select id="nrState" onchange="onStateChange()">
                  <option value="">— Select state —</option>
                </select>
              </div>
              <div class="form-group">
                <label>Records Custodian / Officer Title</label>
                <input type="text" id="nrStateOfficer" placeholder="e.g. Custodian of Records, FOIA Officer…">
              </div>
            </div>
            <div id="stateLawPanel">
              <div class="stateLawPanel-1">
                <div>
                  <div class="stateLawPanel-2">Law Name</div>
                  <div id="slLawName">—</div>
                </div>
                <div>
                  <div class="stateLawPanel-3">Citation</div>
                  <div id="slCitation">—</div>
                </div>
                <div>
                  <div class="stateLawPanel-4">Response Days</div>
                  <div id="slDays">—</div>
                </div>
              </div>
              <div class="stateLawPanel-5">
                <div class="stateLawPanel-6">Notes</div>
                <div id="slNotes">—</div>
              </div>
            </div>
            <div class="form-group">
              <label>Agency Name</label>
              <input type="text" id="nrStateAgency" placeholder="e.g. Missouri State Highway Patrol, Indiana DNR…">
            </div>
          </div>

          <div class="form-group">
            <label>Subject / Records Requested</label>
            <input type="text" id="nrSubject" placeholder="Briefly describe what records you are requesting…">
          </div>

          <div class="form-group">
            <label>Internal Notes (not included in letter)</label>
            <textarea id="nrNotes" placeholder="Investigation context, related cases, prior requests…"></textarea>
          </div>

          <div class="form-actions">
            <button class="btn btn-danger" onclick="clearNewRequestForm()">Discard</button>
            <button class="btn btn-primary" onclick="saveNewRequest()">Save Request</button>
          </div>
        </div>
      </div>

      <!-- ── All Requests ───────────────────────────────────── -->
      <div id="page-all-requests" class="page">
        <div class="card">
          <div class="all-requests-card">
            <button class="btn btn-ghost btn-sm active-filter" data-f="all" onclick="filterAll('all',this)">All</button>
            <button class="btn btn-ghost btn-sm" data-f="new" onclick="filterAll('new',this)">New</button>
            <button class="btn btn-ghost btn-sm" data-f="active" onclick="filterAll('active',this)">Active</button>
            <button class="btn btn-ghost btn-sm" data-f="closed" onclick="filterAll('closed',this)">Closed</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>FOIA #</th>
                  <th>Agency</th>
                  <th>Subject</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="allRequestsBody"></tbody>
            </table>
          </div>
          <div id="allEmpty" class="empty-state">
            <div class="e-icon">—</div>
            <h3>No requests yet</h3>
            <p>Create your first FOIA request to get started.</p>
            <button class="btn btn-primary" onclick="nav('new-request')">+ New Request</button>
          </div>
        </div>
      </div>

      <!-- ── Active Requests ────────────────────────────────── -->
      <div id="page-active-requests" class="page">
        <div class="card">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>FOIA #</th>
                  <th>Agency</th>
                  <th>Deadline</th>
                  <th>Turn</th>
                </tr>
              </thead>
              <tbody id="activeRequestsBody"></tbody>
            </table>
          </div>
          <div id="activeEmpty" class="empty-state">
            <div class="e-icon">—</div>
            <h3>No active requests</h3>
            <p>Save a request letter to move a request into Active status.</p>
          </div>
        </div>
      </div>

      <!-- ── Closed Requests ────────────────────────────────── -->
      <div id="page-closed-requests" class="page">
        <div class="card">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>FOIA #</th>
                  <th>Agency</th>
                  <th>Subject</th>
                  <th>Closed</th>
                </tr>
              </thead>
              <tbody id="closedRequestsBody"></tbody>
            </table>
          </div>
          <div id="closedEmpty" class="empty-state">
            <div class="e-icon">—</div>
            <h3>No closed requests</h3>
            <p>Requests you close will appear here.</p>
          </div>
        </div>
      </div>

      <!-- ── Request Detail ─────────────────────────────────── -->
      <div id="page-detail" class="page">
        <button id="backButton" class="btn btn-ghost btn-sm" onclick="goBack()">← Back</button>
        <div id="detailContent"></div>
      </div>

      <!-- ── Admin: Invite Codes ───────────────────────────────── -->
      <div id="page-admin" class="page">
        <div style="max-width:600px;">
          <h2 style="font-size:1.2rem;font-weight:700;margin-bottom:4px;">Invite Codes</h2>
          <p style="font-size:.85rem;color:var(--text-dim);margin-bottom:24px;">Generate AEOD codes for lifetime free access. Each code can only be used once.</p>

          <div class="card" style="margin-bottom:16px;">
            <h3 style="font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);margin-bottom:14px;">Generate New Codes</h3>
            <div style="display:flex;gap:10px;align-items:center;">
              <input type="number" id="adminCodeCount" value="1" min="1" max="50" style="width:80px;">
              <span style="font-size:.85rem;color:var(--text-dim);">codes</span>
              <button class="btn btn-primary btn-sm" onclick="adminGenerateCodes()">Generate</button>
            </div>
            <div id="adminNewCodes" style="margin-top:16px;display:none;">
              <div style="font-size:.75rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px;">New codes — copy and share these:</div>
              <div id="adminNewCodesList" style="font-family:monospace;font-size:.9rem;background:var(--bg3);border-radius:8px;padding:12px;line-height:2;"></div>
            </div>
          </div>

          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
              <h3 style="font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);">All Codes</h3>
              <button class="btn btn-ghost btn-sm" onclick="adminLoadCodes()">Refresh</button>
            </div>
            <div id="adminCodesList">
              <div style="text-align:center;padding:20px;color:var(--text-dim);font-size:.85rem;">Loading…</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ── Plans & Pricing ───────────────────────────────────── -->
      <div id="page-pricing" class="page">
        <div style="max-width:900px;">

          <h2 style="font-size:1.2rem;font-weight:700;margin-bottom:4px;">Plans &amp; Pricing</h2>
          <p style="font-size:.85rem;color:var(--text-dim);margin-bottom:28px;">Built for the full spectrum — from solo freelancers to institutional investigative teams.</p>

          <!-- Tier cards -->
          <div class="pricing-tiers">

            <!-- Core -->
            <div class="card" style="position:relative;display:flex;flex-direction:column;">
              <div style="font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin-bottom:8px;">Tier 1</div>
              <h3 style="font-size:1.1rem;font-weight:800;margin-bottom:4px;">Core</h3>
              <p style="font-size:.82rem;color:var(--text-dim);line-height:1.6;margin-bottom:16px;">The baseline every reporter needs. A clean, reliable FOIA workspace that eliminates deadline anxiety.</p>
              <ul style="list-style:none;padding:0;margin:0 0 16px;display:flex;flex-direction:column;gap:7px;flex:1;">
                <li style="font-size:.82rem;display:flex;gap:8px;"><span style="color:var(--green);font-weight:700;">✓</span> Unlimited FOIA requests</li>
                <li style="font-size:.82rem;display:flex;gap:8px;"><span style="color:var(--green);font-weight:700;">✓</span> Deadline + appeal-window tracking</li>
                <li style="font-size:.82rem;display:flex;gap:8px;"><span style="color:var(--green);font-weight:700;">✓</span> Notes, timelines, communication logs</li>
                <li style="font-size:.82rem;display:flex;gap:8px;"><span style="color:var(--green);font-weight:700;">✓</span> Basic CSV export</li>
                <li style="font-size:.82rem;display:flex;gap:8px;"><span style="color:var(--green);font-weight:700;">✓</span> Email support</li>
              </ul>
              <div style="font-size:.75rem;color:var(--text-dim);border-top:1px solid var(--border);padding-top:12px;margin-top:auto;">Best for: freelancers, students, early-stage investigations.</div>
            </div>

            <!-- Pro -->
            <div class="card" style="position:relative;display:flex;flex-direction:column;border-color:var(--cyan);box-shadow:0 0 0 1px var(--cyan);">
              <div style="position:absolute;top:-1px;right:16px;background:var(--cyan);color:#000;font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;padding:3px 10px;border-radius:0 0 6px 6px;">Most Popular</div>
              <div style="font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--cyan);margin-bottom:8px;">Tier 2</div>
              <h3 style="font-size:1.1rem;font-weight:800;margin-bottom:4px;">Pro</h3>
              <p style="font-size:.82rem;color:var(--text-dim);line-height:1.6;margin-bottom:16px;">The real workhorse. For reporters managing multiple beats, chronic offenders, and long-running investigations.</p>
              <div style="font-size:.75rem;color:var(--text-dim);margin-bottom:10px;font-style:italic;">Everything in Core, plus:</div>
              <ul style="list-style:none;padding:0;margin:0 0 16px;display:flex;flex-direction:column;gap:7px;flex:1;">
                <li style="font-size:.82rem;display:flex;gap:8px;"><span style="color:var(--green);font-weight:700;">✓</span> Multi-agency portfolio analytics</li>
                <li style="font-size:.82rem;display:flex;gap:8px;"><span style="color:var(--green);font-weight:700;">✓</span> Delay + denial pattern detection</li>
                <li style="font-size:.82rem;display:flex;gap:8px;"><span style="color:var(--green);font-weight:700;">✓</span> Rolling production tracking</li>
                <li style="font-size:.82rem;display:flex;gap:8px;"><span style="color:var(--green);font-weight:700;">✓</span> Advanced search + filters</li>
                <li style="font-size:.82rem;display:flex;gap:8px;"><span style="color:var(--green);font-weight:700;">✓</span> Bulk editing + batch updates</li>
                <li style="font-size:.82rem;display:flex;gap:8px;"><span style="color:var(--green);font-weight:700;">✓</span> Priority support</li>
                <li style="font-size:.82rem;display:flex;gap:8px;"><span style="color:var(--green);font-weight:700;">✓</span> Early access to new features</li>
              </ul>
              <div style="font-size:.75rem;color:var(--text-dim);border-top:1px solid var(--border);padding-top:12px;margin-top:auto;">Best for: investigative reporters, nonprofit researchers, anyone juggling dozens of active requests.</div>
            </div>

            <!-- Newsroom -->
            <div class="card" style="position:relative;display:flex;flex-direction:column;">
              <div style="font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin-bottom:8px;">Tier 3</div>
              <h3 style="font-size:1.1rem;font-weight:800;margin-bottom:4px;">Newsroom</h3>
              <p style="font-size:.82rem;color:var(--text-dim);line-height:1.6;margin-bottom:16px;">Built for teams that need shared visibility, accountability, and continuity across beats and staff turnover.</p>
              <div style="font-size:.75rem;color:var(--text-dim);margin-bottom:10px;font-style:italic;">Everything in Pro, plus:</div>
              <ul style="list-style:none;padding:0;margin:0 0 16px;display:flex;flex-direction:column;gap:7px;flex:1;">
                <li style="font-size:.82rem;display:flex;gap:8px;"><span style="color:var(--green);font-weight:700;">✓</span> Multi-user accounts</li>
                <li style="font-size:.82rem;display:flex;gap:8px;"><span style="color:var(--green);font-weight:700;">✓</span> Shared dashboards + team visibility</li>
                <li style="font-size:.82rem;display:flex;gap:8px;"><span style="color:var(--green);font-weight:700;">✓</span> Request ownership + handoff workflows</li>
                <li style="font-size:.82rem;display:flex;gap:8px;"><span style="color:var(--green);font-weight:700;">✓</span> Internal notes + editorial flags</li>
                <li style="font-size:.82rem;display:flex;gap:8px;"><span style="color:var(--green);font-weight:700;">✓</span> Organization-level analytics</li>
                <li style="font-size:.82rem;display:flex;gap:8px;"><span style="color:var(--green);font-weight:700;">✓</span> Custom exports + audit bundles</li>
                <li style="font-size:.82rem;display:flex;gap:8px;"><span style="color:var(--green);font-weight:700;">✓</span> Dedicated support channel</li>
              </ul>
              <div style="font-size:.75rem;color:var(--text-dim);border-top:1px solid var(--border);padding-top:12px;margin-top:auto;">Best for: newsrooms, legal teams, transparency orgs, multi-reporter investigative units.</div>
            </div>

          </div>

          <!-- Add-ons -->
          <div class="card" style="margin-bottom:32px;">
            <h3 style="font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);margin-bottom:14px;">Optional Add-Ons</h3>
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;">
              <div style="background:var(--bg3);border-radius:8px;padding:12px 14px;">
                <div style="font-size:.85rem;font-weight:600;margin-bottom:3px;">Secure Document Vault</div>
                <div style="font-size:.78rem;color:var(--text-dim);">Encrypted storage for productions and agency responses.</div>
              </div>
              <div style="background:var(--bg3);border-radius:8px;padding:12px 14px;">
                <div style="font-size:.85rem;font-weight:600;margin-bottom:3px;">Agency Contact Database</div>
                <div style="font-size:.78rem;color:var(--text-dim);">Preloaded and maintained directory of FOIA contacts.</div>
              </div>
              <div style="background:var(--bg3);border-radius:8px;padding:12px 14px;">
                <div style="font-size:.85rem;font-weight:600;margin-bottom:3px;">Appeals Toolkit Integration</div>
                <div style="font-size:.78rem;color:var(--text-dim);">Auto-generate appeal drafts directly from denial logs.</div>
              </div>
              <div style="background:var(--bg3);border-radius:8px;padding:12px 14px;">
                <div style="font-size:.85rem;font-weight:600;margin-bottom:3px;">API Access</div>
                <div style="font-size:.78rem;color:var(--text-dim);">For custom dashboards, pipelines, or integrations.</div>
              </div>
            </div>
          </div>

          <!-- Feature comparison table -->
          <div class="card">
            <h3 style="font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);margin-bottom:16px;">Feature Comparison</h3>
            <div class="table-wrap">
              <table style="width:100%;font-size:.82rem;">
                <thead>
                  <tr>
                    <th style="text-align:left;width:55%;">Feature</th>
                    <th style="text-align:center;">Core</th>
                    <th style="text-align:center;color:var(--cyan);">Pro</th>
                    <th style="text-align:center;">Newsroom</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td>Unlimited FOIA Requests</td><td style="text-align:center;color:var(--green);">✓</td><td style="text-align:center;color:var(--green);">✓</td><td style="text-align:center;color:var(--green);">✓</td></tr>
                  <tr><td>Deadline Tracking</td><td style="text-align:center;color:var(--green);">✓</td><td style="text-align:center;color:var(--green);">✓</td><td style="text-align:center;color:var(--green);">✓</td></tr>
                  <tr><td>Appeal Window Tracking</td><td style="text-align:center;color:var(--green);">✓</td><td style="text-align:center;color:var(--green);">✓</td><td style="text-align:center;color:var(--green);">✓</td></tr>
                  <tr><td>Notes + Communication Logs</td><td style="text-align:center;color:var(--green);">✓</td><td style="text-align:center;color:var(--green);">✓</td><td style="text-align:center;color:var(--green);">✓</td></tr>
                  <tr><td>CSV Export</td><td style="text-align:center;color:var(--green);">✓</td><td style="text-align:center;color:var(--green);">✓</td><td style="text-align:center;color:var(--green);">✓</td></tr>
                  <tr><td style="color:var(--text-dim);font-size:.75rem;padding-top:14px;padding-bottom:2px;text-transform:uppercase;letter-spacing:.6px;" colspan="4">Pro &amp; Above</td></tr>
                  <tr><td>Portfolio Analytics</td><td style="text-align:center;color:var(--text-dim);">—</td><td style="text-align:center;color:var(--green);">✓</td><td style="text-align:center;color:var(--green);">✓</td></tr>
                  <tr><td>Delay/Denial Pattern Detection</td><td style="text-align:center;color:var(--text-dim);">—</td><td style="text-align:center;color:var(--green);">✓</td><td style="text-align:center;color:var(--green);">✓</td></tr>
                  <tr><td>Rolling Production Tracking</td><td style="text-align:center;color:var(--text-dim);">—</td><td style="text-align:center;color:var(--green);">✓</td><td style="text-align:center;color:var(--green);">✓</td></tr>
                  <tr><td>Advanced Search + Filters</td><td style="text-align:center;color:var(--text-dim);">—</td><td style="text-align:center;color:var(--green);">✓</td><td style="text-align:center;color:var(--green);">✓</td></tr>
                  <tr><td>Bulk Editing</td><td style="text-align:center;color:var(--text-dim);">—</td><td style="text-align:center;color:var(--green);">✓</td><td style="text-align:center;color:var(--green);">✓</td></tr>
                  <tr><td>Priority Support</td><td style="text-align:center;color:var(--text-dim);">—</td><td style="text-align:center;color:var(--green);">✓</td><td style="text-align:center;color:var(--green);">✓</td></tr>
                  <tr><td>Early Feature Access</td><td style="text-align:center;color:var(--text-dim);">—</td><td style="text-align:center;color:var(--green);">✓</td><td style="text-align:center;color:var(--green);">✓</td></tr>
                  <tr><td style="color:var(--text-dim);font-size:.75rem;padding-top:14px;padding-bottom:2px;text-transform:uppercase;letter-spacing:.6px;" colspan="4">Newsroom Only</td></tr>
                  <tr><td>Multi-User Accounts</td><td style="text-align:center;color:var(--text-dim);">—</td><td style="text-align:center;color:var(--text-dim);">—</td><td style="text-align:center;color:var(--green);">✓</td></tr>
                  <tr><td>Shared Dashboards</td><td style="text-align:center;color:var(--text-dim);">—</td><td style="text-align:center;color:var(--text-dim);">—</td><td style="text-align:center;color:var(--green);">✓</td></tr>
                  <tr><td>Request Ownership + Handoff</td><td style="text-align:center;color:var(--text-dim);">—</td><td style="text-align:center;color:var(--text-dim);">—</td><td style="text-align:center;color:var(--green);">✓</td></tr>
                  <tr><td>Internal Notes + Editorial Flags</td><td style="text-align:center;color:var(--text-dim);">—</td><td style="text-align:center;color:var(--text-dim);">—</td><td style="text-align:center;color:var(--green);">✓</td></tr>
                  <tr><td>Organization-Level Analytics</td><td style="text-align:center;color:var(--text-dim);">—</td><td style="text-align:center;color:var(--text-dim);">—</td><td style="text-align:center;color:var(--green);">✓</td></tr>
                  <tr><td>Custom Exports + Audit Bundles</td><td style="text-align:center;color:var(--text-dim);">—</td><td style="text-align:center;color:var(--text-dim);">—</td><td style="text-align:center;color:var(--green);">✓</td></tr>
                  <tr><td>Dedicated Support Channel</td><td style="text-align:center;color:var(--text-dim);">—</td><td style="text-align:center;color:var(--text-dim);">—</td><td style="text-align:center;color:var(--green);">✓</td></tr>
                </tbody>
              </table>
            </div>
          </div>

        </div>
      </div>

      <!-- ── Help (About / Getting Started / Support) ─────────── -->
      <div id="page-help" class="page">
        <div style="max-width:720px;">

          <!-- Tab bar -->
          <div style="display:flex;gap:4px;margin-bottom:20px;border-bottom:1px solid var(--border);padding-bottom:0;">
            <button onclick="helpTab('about')" id="helpTab-about" class="btn btn-ghost btn-sm" style="border-radius:6px 6px 0 0;border-bottom:2px solid var(--cyan);">About</button>
            <button onclick="helpTab('start')" id="helpTab-start" class="btn btn-ghost btn-sm" style="border-radius:6px 6px 0 0;border-bottom:2px solid transparent;">Getting Started</button>
            <button onclick="helpTab('support')" id="helpTab-support" class="btn btn-ghost btn-sm" style="border-radius:6px 6px 0 0;border-bottom:2px solid transparent;">Support</button>
          </div>

          <!-- About -->
          <div id="helpPane-about" class="card">
            <h2 style="font-size:1.1rem;font-weight:700;margin-bottom:4px;">About FOIA.io</h2>
            <p style="font-size:.8rem;color:var(--text-dim);margin-bottom:20px;">A lightweight records-request workspace for journalists, researchers, and watchdogs.</p>

            <p style="font-size:.9rem;line-height:1.75;margin-bottom:16px;">FOIA.io keeps your requests, deadlines, denials, and appeals in one place—without the bloat of a full case-management system. It's designed around real-world FOIA workflows:</p>
            <ul style="font-size:.9rem;line-height:2;padding-left:1.2em;margin-bottom:20px;">
              <li>Track Federal, State, and University requests in a single dashboard</li>
              <li>Log agency responses, delays, denials, and rolling productions</li>
              <li>Monitor statutory deadlines and appeal windows</li>
              <li>Store notes, follow-ups, and next steps without losing the thread</li>
              <li>Keep your entire FOIA portfolio accessible and audit-ready</li>
            </ul>
            <p style="font-size:.9rem;line-height:1.75;color:var(--text-dim);border-left:3px solid var(--border);padding-left:14px;font-style:italic;">FOIA.io doesn't tell you how to report. It removes the cognitive load so you can focus on the investigation instead of the paperwork.</p>

            <h3 style="font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);margin:24px 0 12px;">Tips for Using FOIA.io</h3>
            <div style="display:flex;flex-direction:column;gap:12px;">
              <div style="display:flex;gap:12px;align-items:flex-start;">
                <span style="font-family:monospace;font-size:.75rem;color:var(--cyan);min-width:20px;padding-top:2px;">01</span>
                <div><strong style="font-size:.88rem;">Update your requests daily.</strong><p style="font-size:.85rem;color:var(--text-dim);margin-top:2px;line-height:1.6;">A 30-second check-in keeps your deadlines accurate and prevents missed appeal windows.</p></div>
              </div>
              <div style="display:flex;gap:12px;align-items:flex-start;">
                <span style="font-family:monospace;font-size:.75rem;color:var(--cyan);min-width:20px;padding-top:2px;">02</span>
                <div><strong style="font-size:.88rem;">Log every agency communication.</strong><p style="font-size:.85rem;color:var(--text-dim);margin-top:2px;line-height:1.6;">Emails, phone calls, "we're still processing," and rolling productions—they all matter later.</p></div>
              </div>
              <div style="display:flex;gap:12px;align-items:flex-start;">
                <span style="font-family:monospace;font-size:.75rem;color:var(--cyan);min-width:20px;padding-top:2px;">03</span>
                <div><strong style="font-size:.88rem;">Use the notes field aggressively.</strong><p style="font-size:.85rem;color:var(--text-dim);margin-top:2px;line-height:1.6;">Document what you asked for, what they said, and what you suspect they're withholding.</p></div>
              </div>
              <div style="display:flex;gap:12px;align-items:flex-start;">
                <span style="font-family:monospace;font-size:.75rem;color:var(--cyan);min-width:20px;padding-top:2px;">04</span>
                <div><strong style="font-size:.88rem;">Track denials immediately.</strong><p style="font-size:.85rem;color:var(--text-dim);margin-top:2px;line-height:1.6;">Appeal deadlines are short. Enter the denial date as soon as it hits your inbox.</p></div>
              </div>
              <div style="display:flex;gap:12px;align-items:flex-start;">
                <span style="font-family:monospace;font-size:.75rem;color:var(--cyan);min-width:20px;padding-top:2px;">05</span>
                <div><strong style="font-size:.88rem;">Keep your portfolio clean.</strong><p style="font-size:.85rem;color:var(--text-dim);margin-top:2px;line-height:1.6;">Archive closed requests so your active list stays scannable.</p></div>
              </div>
              <div style="display:flex;gap:12px;align-items:flex-start;">
                <span style="font-family:monospace;font-size:.75rem;color:var(--cyan);min-width:20px;padding-top:2px;">06</span>
                <div><strong style="font-size:.88rem;">Treat FOIA.io as your institutional memory.</strong><p style="font-size:.85rem;color:var(--text-dim);margin-top:2px;line-height:1.6;">If an agency stonewalls you for six months, you'll want the full timeline at your fingertips.</p></div>
              </div>
            </div>
          </div>

          <!-- Getting Started -->
          <div id="helpPane-start" class="card" style="display:none;">
            <h2 style="font-size:1.1rem;font-weight:700;margin-bottom:4px;">Getting Started</h2>
            <p style="font-size:.8rem;color:var(--text-dim);margin-bottom:20px;">The fastest path from new account to operational FOIA machine.</p>

            <div style="display:flex;flex-direction:column;gap:20px;">
              <div style="display:flex;gap:14px;align-items:flex-start;">
                <span style="font-family:monospace;font-size:.75rem;color:var(--cyan);background:var(--bg3);border-radius:4px;padding:3px 7px;white-space:nowrap;">Step 1</span>
                <div>
                  <strong style="font-size:.92rem;">Add Your First Request</strong>
                  <p style="font-size:.85rem;color:var(--text-dim);margin-top:4px;line-height:1.65;">Start with the basics—the request you already filed or are about to file.</p>
                  <ul style="font-size:.85rem;color:var(--text-dim);line-height:1.9;padding-left:1.2em;margin-top:6px;">
                    <li>Agency name</li>
                    <li>Request description</li>
                    <li>Date submitted</li>
                    <li>Statutory deadline (if known)</li>
                    <li>Tracking number (once assigned)</li>
                  </ul>
                  <p style="font-size:.82rem;color:var(--text-dim);margin-top:6px;font-style:italic;">You can add more detail later. The goal is to get it into the system so the clock starts running.</p>
                </div>
              </div>
              <div style="display:flex;gap:14px;align-items:flex-start;">
                <span style="font-family:monospace;font-size:.75rem;color:var(--cyan);background:var(--bg3);border-radius:4px;padding:3px 7px;white-space:nowrap;">Step 2</span>
                <div>
                  <strong style="font-size:.92rem;">Log Agency Responses as They Come In</strong>
                  <p style="font-size:.85rem;color:var(--text-dim);margin-top:4px;line-height:1.65;">Every email, phone call, delay notice, "still processing," or rolling production belongs here. This builds your timeline—the thing you'll rely on when you appeal, escalate, or write the story.</p>
                </div>
              </div>
              <div style="display:flex;gap:14px;align-items:flex-start;">
                <span style="font-family:monospace;font-size:.75rem;color:var(--cyan);background:var(--bg3);border-radius:4px;padding:3px 7px;white-space:nowrap;">Step 3</span>
                <div>
                  <strong style="font-size:.92rem;">Track Deadlines and Appeal Windows</strong>
                  <p style="font-size:.85rem;color:var(--text-dim);margin-top:4px;line-height:1.65;">FOIA.io calculates estimated response deadlines, appeal windows after denials, and rolling production dates. If a deadline shifts, update the request or denial date and the system recalculates automatically.</p>
                </div>
              </div>
              <div style="display:flex;gap:14px;align-items:flex-start;">
                <span style="font-family:monospace;font-size:.75rem;color:var(--cyan);background:var(--bg3);border-radius:4px;padding:3px 7px;white-space:nowrap;">Step 4</span>
                <div>
                  <strong style="font-size:.92rem;">Use Notes to Capture the Real Story</strong>
                  <p style="font-size:.85rem;color:var(--text-dim);margin-top:4px;line-height:1.65;">The notes field is your investigative memory. Use it for what you asked for, what they claimed, what they're avoiding, and what you need to follow up on. Six months from now, you will be glad you did.</p>
                </div>
              </div>
              <div style="display:flex;gap:14px;align-items:flex-start;">
                <span style="font-family:monospace;font-size:.75rem;color:var(--cyan);background:var(--bg3);border-radius:4px;padding:3px 7px;white-space:nowrap;">Step 5</span>
                <div>
                  <strong style="font-size:.92rem;">Mark Requests as Closed When They're Done</strong>
                  <p style="font-size:.85rem;color:var(--text-dim);margin-top:4px;line-height:1.65;">When you get the records—or the agency gives you a final determination—close it out. Closed requests stay accessible but out of your active workflow, keeping your dashboard clean.</p>
                </div>
              </div>
              <div style="display:flex;gap:14px;align-items:flex-start;">
                <span style="font-family:monospace;font-size:.75rem;color:var(--cyan);background:var(--bg3);border-radius:4px;padding:3px 7px;white-space:nowrap;">Step 6</span>
                <div>
                  <strong style="font-size:.92rem;">Build a Portfolio You Can Actually Use</strong>
                  <p style="font-size:.85rem;color:var(--text-dim);margin-top:4px;line-height:1.65;">As you add more requests, FOIA.io becomes a searchable, sortable record of your reporting. Spot patterns across agencies, track chronic delays, build cases for appeals, and support future stories with past timelines.</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Support -->
          <div id="helpPane-support" class="card" style="display:none;">
            <h2 style="font-size:1.1rem;font-weight:700;margin-bottom:4px;">Contact Support</h2>
            <p style="font-size:.8rem;color:var(--text-dim);margin-bottom:20px;">If something breaks, behaves strangely, or you're convinced the app is gaslighting you, reach out.</p>

            <div style="background:var(--bg3);border-radius:8px;padding:16px 20px;margin-bottom:20px;">
              <div style="font-size:.75rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;">Support Email</div>
              <a href="mailto:support@subtxtpress.com" style="color:var(--cyan);font-size:1rem;font-weight:600;">support@subtxtpress.com</a>
            </div>

            <h3 style="font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);margin-bottom:12px;">What to Include</h3>
            <ul style="font-size:.9rem;line-height:2;padding-left:1.2em;margin-bottom:20px;">
              <li>A short description of what happened</li>
              <li>The request or page you were working on</li>
              <li>Any error messages you saw</li>
              <li>Screenshots if possible</li>
            </ul>

            <p style="font-size:.88rem;line-height:1.75;color:var(--text-dim);border-left:3px solid var(--border);padding-left:14px;font-style:italic;">Every message gets read. If it's a bug, it gets fixed. If it's a feature request, it goes on the roadmap. If it's an agency problem… well, that's between you and them.</p>
          </div>

        </div>
      </div>

      <!-- ── Terms of Service ───────────────────────────────── -->
      <div id="page-terms" class="page">
        <div class="card" style="max-width:720px;">
          <h2 style="font-size:1.2rem;font-weight:700;margin-bottom:4px;">Terms of Service &amp; Privacy Statement</h2>
          <p style="font-size:.8rem;color:var(--text-dim);margin-bottom:24px;">Effective upon use of the service.</p>

          <section style="margin-bottom:20px;">
            <h3 style="font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);margin-bottom:8px;">What FOIA.io Does</h3>
            <p style="font-size:.9rem;line-height:1.7;">FOIA.io helps you track FOIA requests, deadlines, notes, and agency communications. It is a workspace—not a publishing platform, analytics broker, or data-collection service.</p>
          </section>

          <section style="margin-bottom:20px;">
            <h3 style="font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);margin-bottom:8px;">Your Data</h3>
            <ul style="font-size:.9rem;line-height:1.9;padding-left:1.2em;">
              <li>You own all data you enter.</li>
              <li>FOIA.io does not sell, rent, or share your information.</li>
              <li>FOIA.io only stores the minimum data required to operate the service.</li>
              <li>You can export your data at any time.</li>
            </ul>
          </section>

          <section style="margin-bottom:20px;">
            <h3 style="font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);margin-bottom:8px;">How Your Data Is Used</h3>
            <p style="font-size:.9rem;line-height:1.7;margin-bottom:8px;">Your data is used only to:</p>
            <ul style="font-size:.9rem;line-height:1.9;padding-left:1.2em;">
              <li>Display your FOIA portfolio</li>
              <li>Calculate deadlines and timelines</li>
              <li>Maintain your account</li>
              <li>Improve platform stability</li>
            </ul>
            <p style="font-size:.9rem;line-height:1.7;margin-top:8px;">No advertising, tracking, or third-party marketing tools are used.</p>
          </section>

          <section style="margin-bottom:20px;">
            <h3 style="font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);margin-bottom:8px;">Security</h3>
            <ul style="font-size:.9rem;line-height:1.9;padding-left:1.2em;">
              <li>Data is encrypted in transit.</li>
              <li>Access to systems is restricted to authorized personnel.</li>
              <li>No unnecessary personal information is collected.</li>
            </ul>
          </section>

          <section style="margin-bottom:20px;">
            <h3 style="font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);margin-bottom:8px;">Service Reliability</h3>
            <p style="font-size:.9rem;line-height:1.7;">FOIA.io is provided "as is." The platform may experience downtime, bugs, or incomplete features, especially during beta. You are responsible for maintaining your own backups and records.</p>
          </section>

          <section style="margin-bottom:20px;">
            <h3 style="font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);margin-bottom:8px;">Your Responsibilities</h3>
            <ul style="font-size:.9rem;line-height:1.9;padding-left:1.2em;">
              <li>Keep your login credentials secure.</li>
              <li>Enter accurate information for deadline calculations.</li>
              <li>Use the platform lawfully and without disrupting service operations.</li>
              <li>Do not attempt unauthorized access or interfere with platform operations.</li>
            </ul>
          </section>

          <section style="margin-bottom:20px;">
            <h3 style="font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);margin-bottom:8px;">Liability</h3>
            <p style="font-size:.9rem;line-height:1.7;">FOIA.io is not responsible for:</p>
            <ul style="font-size:.9rem;line-height:1.9;padding-left:1.2em;">
              <li>Missed FOIA deadlines</li>
              <li>Agency decisions or delays</li>
              <li>Loss of data due to user error</li>
              <li>Outcomes of your reporting or legal actions</li>
            </ul>
          </section>

          <section style="margin-bottom:20px;">
            <h3 style="font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);margin-bottom:8px;">Changes</h3>
            <p style="font-size:.9rem;line-height:1.7;">Features, functionality, and policies may change as the platform evolves. Continued use means you accept those changes. Notice will be provided when material changes occur.</p>
          </section>

          <section>
            <h3 style="font-size:.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text-dim);margin-bottom:8px;">Contact</h3>
            <p style="font-size:.9rem;line-height:1.7;">Questions, issues, or data concerns: <a href="mailto:support@subtxtpress.com" style="color:var(--cyan);">support@subtxtpress.com</a></p>
          </section>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /app -->

<!-- ── Beta Notice Modal ─────────────────────────────────────── -->
<div class="modal-overlay" id="betaModal" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="modal" style="max-width:480px;">
    <div class="modal-header">
      <div>
        <h2>FOIA.io Beta</h2>
      </div>
      <button class="modal-close" onclick="document.getElementById('betaModal').classList.remove('open')">✕</button>
    </div>
    <div class="modal-body">
      <p style="font-size:.9rem;line-height:1.75;margin-bottom:12px;">FOIA.io is operating in a controlled beta phase.</p>
      <p style="font-size:.9rem;line-height:1.75;color:var(--text-dim);">The platform is fully functional for day‑to‑day FOIA management, but certain features are still undergoing refinement. Users may experience occasional inconsistencies or incomplete functionality. Feedback during this period is actively incorporated into development and stability improvements.</p>
      <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border);font-size:.82rem;color:var(--text-dim);">
        Questions or feedback: <a href="mailto:support@subtxtpress.com" style="color:var(--cyan);">support@subtxtpress.com</a>
      </div>
    </div>
  </div>
</div>

<!-- ── Letter Modal ─────────────────────────────────────────── -->
<div class="modal-overlay" id="letterModal">
  <div class="modal">
    <div class="modal-header">
      <div>
        <h2>📄 FOIA Request Letter</h2>
        <div class="request-letter-modal" id="letterModalSub">Edit the letter below before sending.</div>
      </div>
      <button class="modal-close" onclick="closeLetter()">✕</button>
    </div>
    <div class="modal-body">
      <div
        id="letterText"
        class="letter-pre"
        contenteditable="true"
        spellcheck="true"
      ></div>
      <div class="copy-row">
        <button class="btn btn-ghost btn-sm" onclick="copyLetter()">Copy to Clipboard</button>
        <button class="btn btn-ghost btn-sm" id="btnDownloadDocx" onclick="downloadDocx()">Download .docx</button>
        <span class="copy-success" id="copySuccess">✓ Copied</span>
        <a id="foiaGovLink" href="https://www.foia.gov/create-a-request" target="_blank" rel="noopener"
           class="btn btn-ghost btn-sm">🌐 Open FOIA.gov Portal</a>
      </div>
      <div class="form-actions discard-save">
        <button class="btn btn-danger" onclick="discardLetter()">Discard Letter</button>
        <button class="btn btn-primary" onclick="saveLetter()">Save Letter → Move to Active</button>
      </div>
    </div>
  </div>
</div>

<!-- ── Update Request Modal ─────────────────────────────────── -->
<div class="modal-overlay" id="updateModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Update Request</h2>
      <button class="modal-close" onclick="closeUpdateModal()">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Additional Notes</label>
        <textarea id="updNotes" rows="4" placeholder="Log responses, follow-ups, exemptions cited…"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Override Deadline Date</label>
          <input type="date" id="updDeadline">
        </div>
        <div class="form-group">
          <label>Turn</label>
          <select id="updTurn">
            <option value="My Turn">My Turn</option>
            <option value="Their Turn">Their Turn</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Secondary Contact Name</label>
          <input type="text" id="updSecName" placeholder="Name">
        </div>
        <div class="form-group">
          <label>Secondary Contact Email</label>
          <input type="email" id="updSecEmail" placeholder="email@agency.gov">
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-ghost" onclick="closeUpdateModal()">Discard</button>
        <button class="btn btn-primary" onclick="saveUpdate()">Save Updates</button>
      </div>
    </div>
  </div>
</div>

<!-- ── Appeal Modal ──────────────────────────────────────────── -->
<div class="modal-overlay" id="appealModal">
  <div class="modal">
    <div class="modal-header">
      <div>
        <h2>⚖︎ Administrative Appeal</h2>
        <div id="appealModalSub"></div>
      </div>
      <button class="modal-close" onclick="closeAppealModal()">✕</button>
    </div>
    <div class="modal-body">
      <div class="form-row appeal-type">
        <div class="form-group">
          <label>Appeal Type</label>
          <select id="appealType" onchange="onAppealTypeChange()">
            <option value="constructive_denial">No Response / Constructive Denial</option>
            <option value="improper_exemption">Improper Exemption Claimed</option>
            <option value="inadequate_search">Inadequate Search</option>
            <option value="fee_dispute">Fee Dispute</option>
          </select>
        </div>
        <div class="form-group" id="exemptionRow" style="display:none;">
          <label>Exemption Cited by Agency</label>
          <input type="text" id="appealExemption" placeholder="e.g. 5, 7(C), 7(E)…">
        </div>
      </div>
      <div
        id="appealText"
        class="letter-pre"
        contenteditable="true"
        spellcheck="true"
        style="min-height:360px;"
      ></div>
      <div class="copy-row copy-to-clipboard">
        <button class="btn btn-ghost btn-sm" onclick="copyAppeal()">Copy to Clipboard</button>
        <span class="copy-success" id="appealCopySuccess">✓ Copied</span>
        <button class="btn btn-ghost btn-sm regenerate-btn" onclick="regenerateAppeal()">Regenerate</button>
      </div>
      <div class="form-actions discard-save">
        <button class="btn btn-danger" onclick="closeAppealModal()">Discard</button>
        <button class="btn btn-primary" onclick="saveAppeal()">Save Appeal → Mark as Appealed</button>
      </div>
    </div>
  </div>
</div>

<!-- ── Toast ────────────────────────────────────────────────── -->
<div id="toast"></div>

<!-- ── Subscribe Page (shown over app when needed) ─────────── -->
<div id="subscribePage">
  <div class="subscribe-card">
    <div style="font-size:2.5rem;margin-bottom:12px;">📁</div>
    <h2>Unlock FOIA.io</h2>
    <p>Manage unlimited FOIA requests, auto-generate letters, and track every deadline.</p>
    <div class="price-tag">$19 <span>/ month</span></div>
    <ul class="feature-list">
      <li>Unlimited requests across all statuses</li>
      <li>Auto-generated FOIA numbers &amp; letters</li>
      <li>Federal agency directory (20+ agencies)</li>
      <li>Deadline tracking with business-day math</li>
      <li>Full action log per request</li>
      <li>Word doc letter export</li>
      <li>Fee waiver boilerplate included</li>
    </ul>
    <button class="btn btn-primary stripe-btn" onclick="goToCheckout()">
      Subscribe with Stripe →
    </button>
    <p class="activate-free-trial">
      During development, use the button below to activate a free trial.
    </p>
    <button class="btn btn-ghost dev-access" onclick="devActivate()">
      🛠 Dev: Activate Free Access
    </button>
  </div>
</div>

<script>
// ─────────────────────────────────────────────────────────────
// State
// ─────────────────────────────────────────────────────────────
let currentPage = 'dashboard';
let previousPage = 'dashboard';
let currentRequestId = null;
let allRequestsData = [];
let agenciesData = [];
let pendingLetterId = null;
let pendingUpdateId = null;

// ─────────────────────────────────────────────────────────────
// API helper
// ─────────────────────────────────────────────────────────────
async function api(method, path, body) {
  const opts = {
    method,
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include'
  };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(path, opts);
  return { status: res.status, data: await res.json().catch(() => ({})) };
}

// ─────────────────────────────────────────────────────────────
// Toast
// ─────────────────────────────────────────────────────────────
function toast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'show ' + type;
  clearTimeout(t._tid);
  t._tid = setTimeout(() => t.className = '', 3200);
}

// ─────────────────────────────────────────────────────────────
// Auth
// ─────────────────────────────────────────────────────────────
function authTab(tab) {
  document.querySelectorAll('.auth-tab').forEach(b => b.classList.toggle('active', b.textContent.toLowerCase().includes(tab)));
  document.getElementById('loginForm').style.display    = tab === 'login'    ? '' : 'none';
  document.getElementById('registerForm').style.display = tab === 'register' ? '' : 'none';
  document.getElementById('authError').style.display    = 'none';
}

async function doLogin() {
  const username = document.getElementById('loginUser').value.trim();
  const password = document.getElementById('loginPass').value;
  const { status, data } = await api('POST', '/api/auth/login', { username, password });
  if (status !== 200) {
    showAuthError(data.error || 'Login failed');
    return;
  }
  bootApp(data.username, data.subscription_status);
}

async function doRegister() {
  const username    = document.getElementById('regUser').value.trim();
  const email       = document.getElementById('regEmail').value.trim();
  const password    = document.getElementById('regPass').value;
  const invite_code = document.getElementById('regInvite').value.trim().toUpperCase();
  const { status, data } = await api('POST', '/api/auth/register', { username, email, password, invite_code });
  if (status !== 200) {
    showAuthError(data.error || 'Registration failed');
    return;
  }
  bootApp(data.username, data.subscription_status || 'active');
}

async function doLogout() {
  await api('POST', '/api/auth/logout');
  location.reload();
}

function showAuthError(msg) {
  const el = document.getElementById('authError');
  el.textContent = msg;
  el.style.display = 'block';
}

// ─────────────────────────────────────────────────────────────
// Theme toggle
// ─────────────────────────────────────────────────────────────
function initTheme() {
  const saved = localStorage.getItem('foiaio-theme') || 'dark';
  applyTheme(saved);
}

function applyTheme(theme) {
  if (theme === 'light') {
    document.documentElement.setAttribute('data-theme', 'light');
    document.getElementById('themeIcon').textContent  = '☾';
    document.getElementById('themeLabel').textContent = 'Dark Mode';
  } else {
    document.documentElement.removeAttribute('data-theme');
    document.getElementById('themeIcon').textContent  = '☼';
    document.getElementById('themeLabel').textContent = 'Light Mode';
  }
  localStorage.setItem('foiaio-theme', theme);
}

function toggleTheme() {
  const current = localStorage.getItem('foiaio-theme') || 'dark';
  applyTheme(current === 'dark' ? 'light' : 'dark');
}

async function bootApp(username, subStatus) {
  document.getElementById('authWrap').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  window.scrollTo(0, 0);
  document.getElementById('userName').textContent = username;
  document.getElementById('userAvatar').textContent = username[0].toUpperCase();
  initTheme();

  // ── TEST MODE: subscription gate disabled ──────────────────
  await loadAgencies();
  await refreshAllData();

  // Show admin nav if the logged-in user is an admin
  const { status: adminStatus } = await api('GET', '/api/admin/invite-codes');
  if (adminStatus === 200) {
    document.getElementById('adminNavSection').style.display = '';
    document.getElementById('adminNavBtn').style.display = '';
  }

  nav('dashboard');
}

// ─────────────────────────────────────────────────────────────
// Subscription
// ─────────────────────────────────────────────────────────────
async function goToCheckout() {
  const { status, data } = await api('POST', '/api/stripe/create-checkout', {});
  toast(data.message || 'Redirecting to Stripe…', '');
}

async function devActivate() {
  const { status, data } = await api('POST', '/api/dev/activate', {});
  if (status === 200) {
    document.getElementById('subscribePage').style.display = 'none';
    await loadAgencies();
    await refreshAllData();
    nav('dashboard');
    toast('Dev access activated ✓', 'success');
  }
}

// ─────────────────────────────────────────────────────────────
// Navigation
// ─────────────────────────────────────────────────────────────
const PAGE_TITLES = {
  'dashboard':       'Dashboard',
  'new-request':     'New Request',
  'all-requests':    'All Requests',
  'active-requests': 'Active Requests',
  'closed-requests': 'Closed Requests',
  'agency-dir':      'Federal Agency Directory',
  'state-laws':      'State Public Records Laws',
  'detail':          'Request Detail',
  'terms':           'Terms of Service',
  'help':            'Help',
  'pricing':         'Plans & Pricing',
  'admin':           'Admin',
};

async function nav(page) {
  previousPage = currentPage;
  currentPage = page;

  // Scroll to top on every page transition
  window.scrollTo(0, 0);
  const mainEl = document.getElementById('main');
  if (mainEl) mainEl.scrollTop = 0;

  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(b => {
    b.classList.toggle('active', b.dataset.page === page);
  });
  const el = document.getElementById(`page-${page}`);
  if (el) el.classList.add('active');
  document.getElementById('topbarTitle').textContent = PAGE_TITLES[page] || page;
  closeSidebar();

  if (page === 'dashboard')       await loadDashboard();
  if (page === 'all-requests')    await loadAllRequests();
  if (page === 'active-requests') await loadActiveRequests();
  if (page === 'closed-requests') await loadClosedRequests();
  if (page === 'new-request')     await initNewRequestForm();
  if (page === 'agency-dir')      await loadAgencyDir();
  if (page === 'state-laws')      await loadStateLaws();
  if (page === 'admin')           adminLoadCodes();
}

function goBack() { nav(previousPage === 'detail' ? 'all-requests' : previousPage); }

// ─────────────────────────────────────────────────────────────
// Sidebar (mobile)
// ─────────────────────────────────────────────────────────────
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').style.display =
    document.getElementById('sidebar').classList.contains('open') ? '' : 'none';
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').style.display = 'none';
}

// Sidebar nav scroll fade
(function() {
  const nav = document.getElementById('sidebarNav');
  const wrap = nav && nav.parentElement;
  if (!nav || !wrap) return;
  function updateFade() {
    const atBottom = nav.scrollTop + nav.clientHeight >= nav.scrollHeight - 4;
    wrap.classList.toggle('at-bottom', atBottom);
  }
  nav.addEventListener('scroll', updateFade, { passive: true });
  // Re-check whenever sidebar opens (content may have changed)
  document.getElementById('sidebar').addEventListener('transitionend', updateFade);
  updateFade();
})();

// ─────────────────────────────────────────────────────────────
// Data loaders
// ─────────────────────────────────────────────────────────────
async function refreshAllData() {
  const { data } = await api('GET', '/api/requests');
  allRequestsData = Array.isArray(data) ? data : [];
  updateBadges();
}

function updateBadges() {
  const all    = allRequestsData.length;
  const active = allRequestsData.filter(r => r.status === 'active').length;
  const closed = allRequestsData.filter(r => r.status === 'closed').length;
  document.getElementById('badgeAll').textContent    = all;
  document.getElementById('badgeActive').textContent = active;
  document.getElementById('badgeClosed').textContent = closed;

  const overdue = allRequestsData.filter(r =>
    r.status === 'active' && r.days_since_deadline > 0
  ).length;
  const badge = document.getElementById('badgeActive');
  if (overdue > 0) badge.classList.add('red'); else badge.classList.remove('red');
}

async function loadDashboard() {
  await refreshAllData();
  const total   = allRequestsData.length;
  const active  = allRequestsData.filter(r => r.status === 'active').length;
  const closed  = allRequestsData.filter(r => r.status === 'closed').length;
  const overdue = allRequestsData.filter(r =>
    r.status === 'active' && r.days_since_deadline > 0
  ).length;

  document.getElementById('statTotal').textContent   = total;
  document.getElementById('statActive').textContent  = active;
  document.getElementById('statOverdue').textContent = overdue;
  document.getElementById('statClosed').textContent  = closed;

  // Recent
  const recent = [...allRequestsData]
    .sort((a, b) => (b.updated_at || '').localeCompare(a.updated_at || ''))
    .slice(0, 5);
  document.getElementById('dashRecentList').innerHTML =
    recent.length ? renderMiniTable(recent) :
    '<p style="color:var(--text-dim);padding:20px 0;text-align:center;">No requests yet.</p>';

  // Overdue
  const od = allRequestsData.filter(r =>
    r.status === 'active' && r.days_since_deadline > 0
  );
  document.getElementById('dashOverdueList').innerHTML =
    od.length ? renderMiniTable(od) :
    '<p style="color:var(--green);padding:20px 0;text-align:center;">✓ No overdue requests</p>';
}

function renderMiniTable(rows) {
  return `<div class="table-wrap"><table>
    <thead><tr><th>FOIA #</th><th>Agency</th><th>Status</th></tr></thead>
    <tbody>${rows.map(r => `
      <tr onclick="openDetail(${r.id})">
        <td class="td-number">${esc(r.foia_number)}</td>
        <td class="td-agency">${esc(r.agency_name||'—')}</td>
        <td>${statusBadge(r)}</td>
      </tr>`).join('')}
    </tbody>
  </table></div>`;
}

async function loadAllRequests(filter = 'all') {
  await refreshAllData();
  let rows = filter === 'all' ? allRequestsData :
             allRequestsData.filter(r => r.status === filter);
  const tbody = document.getElementById('allRequestsBody');
  tbody.innerHTML = rows.map(r => `
    <tr onclick="openDetail(${r.id})">
      <td class="td-number">${esc(r.foia_number)}</td>
      <td class="td-agency">${esc(r.agency_name||'—')}</td>
      <td class="td-subject">${esc(r.subject||'—')}</td>
      <td>${statusBadge(r)}</td>
    </tr>`).join('');
  document.getElementById('allEmpty').style.display = rows.length ? 'none' : '';
}

async function loadActiveRequests() {
  await refreshAllData();
  const rows = allRequestsData.filter(r => r.status === 'active' || r.status === 'appealed');
  const tbody = document.getElementById('activeRequestsBody');
  tbody.innerHTML = rows.map(r => {
    const dsd = r.days_since_deadline ?? null;
    let daysTxt = '—';
    if (dsd !== null) {
      if (dsd > 0)       daysTxt = `<span style="color:var(--red)">+${dsd}d overdue</span>`;
      else if (dsd === 0) daysTxt = `<span style="color:var(--amber)">Due today</span>`;
      else                daysTxt = `<span style="color:var(--green)">${Math.abs(dsd)}d left</span>`;
    }
    const turnDropdown = `
      <select class="turn-select" onclick="event.stopPropagation()"
              onchange="quickSetTurn(${r.id}, this.value)"
              style="background:var(--bg3);border:1px solid var(--border);color:${r.turn==='Their Turn'?'var(--cyan)':'var(--amber)'};
                     padding:4px 8px;border-radius:6px;font-size:.78rem;font-weight:700;cursor:pointer;outline:none;">
        <option value="My Turn"   ${r.turn!=='Their Turn'?'selected':''}>My Turn</option>
        <option value="Their Turn" ${r.turn==='Their Turn'?'selected':''}>Their Turn</option>
      </select>`;
    return `<tr onclick="openDetail(${r.id})">
      <td class="td-number">${esc(r.foia_number)}</td>
      <td class="td-agency">${esc(r.agency_name||'—')}</td>
      <td>${fmtDate(r.deadline_date)}</td>
      <td>${turnDropdown}</td>
    </tr>`;
  }).join('');
  document.getElementById('activeEmpty').style.display = rows.length ? 'none' : '';
}

async function loadClosedRequests() {
  await refreshAllData();
  const rows = allRequestsData.filter(r => r.status === 'closed');
  const tbody = document.getElementById('closedRequestsBody');
  tbody.innerHTML = rows.map(r => `
    <tr onclick="openDetail(${r.id})">
      <td class="td-number">${esc(r.foia_number)}</td>
      <td class="td-agency">${esc(r.agency_name||'—')}</td>
      <td class="td-subject">${esc(r.subject||'—')}</td>
      <td>${fmtDate(r.closed_date)}</td>
    </tr>`).join('');
  document.getElementById('closedEmpty').style.display = rows.length ? 'none' : '';
}

async function loadAgencies() {
  const { data } = await api('GET', '/api/agencies');
  agenciesData = Array.isArray(data) ? data : [];
  const sel = document.getElementById('nrAgency');
  if (!sel) return;
  sel.innerHTML = '<option value="">— Select agency —</option>' +
    agenciesData.map(a =>
      `<option value="${a.id}">${esc(a.name)}${a.abbreviation ? ' ('+esc(a.abbreviation)+')' : ''}</option>`
    ).join('') +
    '<option value="__manual__">✏️ Not listed — enter manually</option>';
}

async function loadAgencyDir() {
  const tbody = document.getElementById('agencyDirBody');
  const tableHead = document.querySelector('#agencyDirModal thead');
  tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text-dim);">Loading…</td></tr>';
  const { status, data: agencies } = await api('GET', '/api/agencies');
  if (status !== 200 || !Array.isArray(agencies)) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--red);">Error loading agencies. Please try again.</td></tr>';
    return;
  }
  const isMobile = window.innerWidth <= 768;
  if (isMobile && tableHead) tableHead.style.display = 'none';
  else if (tableHead) tableHead.style.display = '';
  tbody.innerHTML = '';
  for (const full of agencies) {
    const tr = document.createElement('tr');
    const email = full.foia_email || '';
    if (isMobile) {
      tr.innerHTML = `
        <td colspan="6" style="padding:10px 12px;border-bottom:1px solid var(--border);">
          <div style="font-weight:600;font-size:.78rem;margin-bottom:5px;">${esc(full.name)}</div>
          <div style="margin-bottom:4px;"><span class="badge badge-active">${esc(full.abbreviation||'—')}</span></div>
          <div style="display:flex;align-items:center;gap:6px;">
            ${email ? `<a href="mailto:${esc(email)}" style="color:var(--cyan);font-size:.7rem;word-break:break-all;">${esc(email)}</a>
            <button class="copy-ref-btn" onclick="copyRef(this,'${email.replace(/'/g,"\'")}','Email copied')" title="Copy email" style="flex-shrink:0;">⎘</button>`
            : `<span style="color:var(--text-dim);font-style:italic;font-size:.7rem;">Call agency for email</span>`}
          </div>
        </td>`;
    } else {
      tr.innerHTML = `
        <td style="font-weight:600;padding:8px 12px;">${esc(full.name)}</td>
        <td style="padding:8px 12px;"><span class="badge badge-active">${esc(full.abbreviation||'—')}</span></td>
        <td style="padding:8px 12px;word-break:break-all;">${email ? `<a href="mailto:${esc(email)}" style="color:var(--cyan);">${esc(email)}</a>` : `<span style="color:var(--text-dim);font-style:italic;">Call agency for email</span>`}</td>
        <td class="hide-mobile" style="padding:8px 12px;">${esc(full.foia_phone||'—')}</td>
        <td style="padding:8px 12px;">${email ? `<button class="copy-ref-btn" onclick="copyRef(this,'${email.replace(/'/g,"\'")}','Email copied')" title="Copy email">⎘</button>` : ''}</td>`;
    }
    tbody.appendChild(tr);
  }
}

// ─────────────────────────────────────────────────────────────
// New Request Form
// ─────────────────────────────────────────────────────────────
async function initNewRequestForm() {
  const { data } = await api('GET', '/api/requests/new-number');
  document.getElementById('nrFoiaNum').value = data.foia_number || '';
  document.getElementById('nrDate').value    = data.date || new Date().toISOString().split('T')[0];
  document.getElementById('nrType').value    = '';
  document.getElementById('nrSubject').value = '';
  document.getElementById('nrNotes').value   = '';
  document.getElementById('federalAgencySection').style.display = 'none';
  document.getElementById('stateSection').style.display = 'none';
  document.getElementById('localUnivSection').style.display = 'none';
  document.getElementById('manualJurisdictionSection').style.display = 'none';
  document.getElementById('federalManualEntry').style.display = 'none';
  document.getElementById('agencyInfoPanel').classList.remove('visible');
  document.getElementById('stateLawPanel').style.display = 'none';
  document.getElementById('nrAgency').value  = '';
  document.getElementById('nrState').value   = '';
  document.getElementById('nrStateAgency').value = '';
  document.getElementById('nrStateOfficer').value = '';
  // Reset manual entry fields
  const manualJ = document.getElementById('nrManualJurisdiction');
  if (manualJ) manualJ.value = '';
  const manualA = document.getElementById('nrManualAgency');
  if (manualA) manualA.value = '';
  const fedManualA = document.getElementById('nrFedManualAgency');
  if (fedManualA) fedManualA.value = '';
  const localA = document.getElementById('nrLocalAgency');
  if (localA) localA.value = '';
  const localS = document.getElementById('nrLocalState');
  if (localS) localS.value = '';
  await loadAgencies();
  await loadStatesDropdown();
}

function onTypeChange() {
  const t = document.getElementById('nrType').value;
  document.getElementById('federalAgencySection').style.display =
    t === 'Federal' ? '' : 'none';
  document.getElementById('stateSection').style.display =
    t === 'State' ? 'block' : 'none';
  document.getElementById('localUnivSection').style.display =
    (t === 'Local' || t === 'University') ? '' : 'none';
  document.getElementById('manualJurisdictionSection').style.display =
    t === 'Other' ? '' : 'none';

    
  // Populate the state dropdown for State jurisdiction
  if (t === 'State') {
    loadStatesDropdown();
  }

  // Update label for local vs university
  const lbl = document.getElementById('localUnivAgencyLabel');
  if (lbl) lbl.textContent = t === 'University' ? 'Institution Name' : 'Agency Name';

  // Populate the local/univ state dropdown if needed
  if (t === 'Local' || t === 'University') {
    populateLocalStateDropdown();
  }
}

let statesData = [];

async function populateLocalStateDropdown() {
  const sel = document.getElementById('nrLocalState');
  if (!sel || sel.options.length > 1) return; // already populated
  if (statesData.length === 0) {
    const { data } = await api('GET', '/api/states');
    statesData = Array.isArray(data) ? data : [];
  }
  sel.innerHTML = '<option value="">— Select state —</option>' +
    statesData.map(s =>
      `<option value="${esc(s.state_code)}">${esc(s.state_name)}</option>`
    ).join('');
}

async function loadStatesDropdown() {
  const sel = document.getElementById('nrState');
  if (!sel) return;
  if (sel.options.length > 1) return; // already populated
  
  // Fetch states from API
  if (statesData.length === 0) {
    const { data } = await api('GET', '/api/states');
    statesData = Array.isArray(data) ? data : [];
  }
  
  // Populate dropdown
  sel.innerHTML = '<option value="">— Select state —</option>' +
    statesData.map(s =>
      `<option value="${s.state_code}">${s.state_name}</option>`
    ).join('');
}


async function onStateChange() {
  const code = document.getElementById('nrState').value;
  if (!code) {
    document.getElementById('stateLawPanel').style.display = 'none';
    return;
  }
  const { data } = await api('GET', `/api/states/${code}`);
  document.getElementById('slLawName').textContent  = data.law_name || '—';
  document.getElementById('slCitation').textContent = data.citation || '—';
  document.getElementById('slDays').textContent     =
    data.response_days ? `${data.response_days} business days` : 'Reasonable time';
  document.getElementById('slNotes').textContent    = data.notes || '—';
  document.getElementById('stateLawPanel').style.display = '';
}

async function loadStateLaws() {
  const { data } = await api('GET', '/api/states');
  const tbody = document.getElementById('stateLawsBody');
  tbody.innerHTML = data.map(s => `
    <tr>
      <td style="font-weight:600;">${esc(s.state_name)}</td>
      <td><span class="badge badge-active">${esc(s.state_code)}</span></td>
      <td style="font-size:.82rem;">${esc(s.law_name)}</td>
      <td style="font-size:.78rem;color:var(--cyan);font-family:monospace;">${esc(s.citation)}</td>
      <td style="text-align:center;">${s.response_days || '<span style="color:var(--text-dim)">Reasonable</span>'}</td>
      <td style="text-align:center;">${s.appeal_days || '<span style="color:var(--text-dim)">—</span>'}</td>
      <td style="font-size:.78rem;color:var(--text-dim);max-width:300px;">${esc(s.notes||'')}</td>
      <td><button class="copy-ref-btn" onclick="copyRef(this,'${esc(s.citation).replace(/'/g,"\'").replace(/"/g,'&quot;')}','Citation copied')" title="Copy citation">⎘</button></td>
    </tr>`).join('');
}

async function onAgencyChange() {
  const id = document.getElementById('nrAgency').value;
  const manualEntry = document.getElementById('federalManualEntry');

  if (id === '__manual__') {
    // Show manual entry, hide agency info panel
    if (manualEntry) manualEntry.style.display = '';
    document.getElementById('agencyInfoPanel').classList.remove('visible');
    document.getElementById('aipPortalRow').style.display = 'none';
    return;
  }

  // Hide manual entry when a real agency is selected
  if (manualEntry) manualEntry.style.display = 'none';

  if (!id) {
    document.getElementById('agencyInfoPanel').classList.remove('visible');
    document.getElementById('aipPortalRow').style.display = 'none';
    return;
  }
  const { data } = await api('GET', `/api/agencies/${id}`);
  document.getElementById('aipTitle').textContent   = data.foia_officer_title || 'Call agency for contact name';
  document.getElementById('aipEmail').textContent   = data.foia_email || 'Call agency for email address';
  document.getElementById('aipPhone').textContent   = data.foia_phone || '—';
  document.getElementById('aipFax').textContent     = data.foia_fax || 'Call agency for fax number';
  document.getElementById('aipAddress').textContent = data.foia_address || 'Call agency for mailing address';
  // Portal link
  if (data.portal_url) {
    document.getElementById('aipPortalLink').href = data.portal_url;
    document.getElementById('aipPortalRow').style.display = '';
  } else {
    document.getElementById('aipPortalRow').style.display = 'none';
  }
  document.getElementById('agencyInfoPanel').classList.add('visible');
}

function clearNewRequestForm() {
  if (!confirm('Discard this request?')) return;
  initNewRequestForm();
}

async function saveNewRequest() {
  const agencyType = document.getElementById('nrType').value;
  const agencyIdRaw = document.getElementById('nrAgency').value || null;
  const agencyId   = (agencyIdRaw && agencyIdRaw !== '__manual__') ? agencyIdRaw : null;
  const subject    = document.getElementById('nrSubject').value.trim();
  const notes      = document.getElementById('nrNotes').value.trim();
  const stateCode  = document.getElementById('nrState')?.value || null;
  const stateAgency = document.getElementById('nrStateAgency')?.value.trim() || '';
  const stateOfficer = document.getElementById('nrStateOfficer')?.value.trim() || '';
  const filedDate  = document.getElementById('nrDate').value || null;

  // Manual entry fields
  const manualJurisdiction = document.getElementById('nrManualJurisdiction')?.value.trim() || '';
  const otherManualAgency = document.getElementById('nrManualAgency')?.value.trim() || '';
  const fedManualAgency = document.getElementById('nrFedManualAgency')?.value.trim() || '';
  const localAgency = document.getElementById('nrLocalAgency')?.value.trim() || '';
  const localStateCode = document.getElementById('nrLocalState')?.value || null;

  if (!agencyType) { toast('Please select a jurisdiction', 'error'); return; }
  if (agencyType === 'Other' && !manualJurisdiction) { toast('Please enter the jurisdiction', 'error'); return; }
  if (agencyType === 'Federal' && !agencyId && !fedManualAgency) { toast('Please select an agency or enter one manually', 'error'); return; }
  if (agencyType === 'State' && !stateCode) { toast('Please select a state', 'error'); return; }
  if (agencyType === 'State' && !stateAgency) { toast('Please enter the agency name', 'error'); return; }
  if ((agencyType === 'Local' || agencyType === 'University') && !localAgency) { toast('Please enter the agency/institution name', 'error'); return; }
  if (!subject) { toast('Please enter a subject', 'error'); return; }

  // Determine final agency_type and agency_name
  let finalAgencyType = agencyType;
  let finalAgencyName = '';
  let finalStateCode = null;

  if (agencyType === 'Other') {
    finalAgencyType = manualJurisdiction;
    finalAgencyName = otherManualAgency;
  } else if (agencyType === 'Federal') {
    finalAgencyName = fedManualAgency || ''; // overridden by backend if agencyId set
  } else if (agencyType === 'State') {
    finalAgencyName = stateAgency;
    finalStateCode = stateCode;
  } else if (agencyType === 'Local' || agencyType === 'University') {
    finalAgencyName = localAgency;
    finalStateCode = localStateCode;
  }

  const payload = {
    agency_type: finalAgencyType,
    agency_id: agencyId ? parseInt(agencyId) : null,
    agency_name: finalAgencyName,
    state_code: finalStateCode,
    foia_officer_title: agencyType === 'State' ? (stateOfficer || 'Custodian of Records') : undefined,
    subject, notes,
    filed_date: filedDate
  };

  const { status, data } = await api('POST', '/api/requests', payload);

  if (status !== 200) {
    toast(data.error || 'Save failed', 'error');
    return;
  }

  toast(`✓ Saved as ${data.foia_number}`, 'success');
  await refreshAllData();
  nav('all-requests');
}

// ─────────────────────────────────────────────────────────────
// Filter
// ─────────────────────────────────────────────────────────────
function filterAll(f, btn) {
  document.querySelectorAll('.active-filter').forEach(b => b.classList.remove('active-filter'));
  btn.classList.add('active-filter');
  loadAllRequests(f);
}

// ─────────────────────────────────────────────────────────────
// Request Detail
// ─────────────────────────────────────────────────────────────
async function openDetail(id) {
  currentRequestId = id;
  const { data: r } = await api('GET', `/api/requests/${id}`);
  const { data: log } = await api('GET', `/api/requests/${id}/log`);

  previousPage = currentPage;
  currentPage = 'detail';
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-detail').classList.add('active');
  document.getElementById('topbarTitle').textContent = r.foia_number;

  // Scroll to top when opening detail
  window.scrollTo(0, 0);
  const mainEl = document.getElementById('main');
  if (mainEl) mainEl.scrollTop = 0;

  const dsd = r.days_since_deadline ?? null;
  let deadlineBanner = '';
  if (r.status === 'active' && r.deadline_date) {
    let cls = 'ok', msg = '';
    if (dsd > 0)       { cls = 'over'; msg = `⚑ Overdue by ${dsd} business days (deadline was ${fmtDate(r.deadline_date)})`; }
    else if (dsd === 0){ cls = 'warn'; msg = `⏲ Deadline is TODAY — ${fmtDate(r.deadline_date)}`; }
    else if (dsd > -5) { cls = 'warn'; msg = `⏲ Deadline approaching — ${fmtDate(r.deadline_date)} (${Math.abs(dsd)} days remaining)`; }
    else               { cls = 'ok';   msg = `✓ On track — deadline ${fmtDate(r.deadline_date)} (${Math.abs(dsd)} days remaining)`; }
    deadlineBanner = `<div class="deadline-banner ${cls}">${msg}</div>`;
  }

  const logHtml = Array.isArray(log) && log.length
    ? `<ul class="action-log-list">${log.map(l => `
        <li>
          <div class="al-date">${fmtDateTime(l.logged_at)}</div>
          <div>
            <div class="al-action">${esc(l.action)}</div>
            ${l.note ? `<div class="al-note">${esc(l.note)}</div>` : ''}
          </div>
        </li>`).join('')}
      </ul>`
    : '<p style="color:var(--text-dim);font-size:.85rem;">No actions logged yet.</p>';

  const isActive = r.status === 'active';
  const isNew    = r.status === 'new';
  const isClosed = r.status === 'closed';
  const isAppealed = r.status === 'appealed';

  document.getElementById('detailContent').innerHTML = `
    <div class="detail-header">
      <div>
        <h2 style="font-size:1.2rem;font-weight:800;color:var(--cyan);">${esc(r.foia_number)}</h2>
        <div style="font-size:0.9rem;font-weight:600;margin-top:6px;">${esc(r.subject||'—')}</div>
        <div class="detail-meta">
          <div class="meta-chip"><strong>Agency:</strong> ${esc(r.agency_name||'—')}</div>
          <div class="meta-chip"><strong>Created:</strong> ${fmtDate(r.created_date)}</div>
          <div class="meta-chip"><strong>Status:</strong> ${statusBadge(r)}</div>
          ${isActive ? `<div class="meta-chip"><strong>Turn:</strong> ${r.turn||'My Turn'}</div>` : ''}
          ${r.secondary_contact_name ? `<div class="meta-chip"><strong>2nd Contact:</strong> ${esc(r.secondary_contact_name)}</div>` : ''}
          ${r.last_action_date ? `<div class="meta-chip"><strong>Last Action:</strong> ${fmtDateTime(r.last_action_date)}</div>` : ''}
        </div>
      </div>
      <div class="detail-actions" style="display:flex;flex-wrap:wrap;gap:6px;">
        ${isNew ? `<button class="btn btn-primary btn-sm" onclick="openLetter(${r.id})">📄 View/Send Letter</button>` : ''}
        ${isActive ? `
          <button class="btn btn-ghost btn-sm" onclick="openLetter(${r.id})">📄 View Letter</button>
          <button class="btn btn-primary btn-sm" onclick="openUpdateModal(${r.id})">Update Request</button>
          <button class="btn btn-ghost btn-sm" onclick="openAppealModal(${r.id})" style="border-color:var(--amber);color:var(--amber);">File Appeal</button>
          <button class="btn btn-danger btn-sm" onclick="closeReq(${r.id})">Close Request</button>` : ''}
        ${r.status === 'appealed' ? `
          <button class="btn btn-ghost btn-sm" onclick="openLetter(${r.id})">📄 View Letter</button>
          <button class="btn btn-ghost btn-sm" onclick="openAppealModal(${r.id})" style="border-color:var(--amber);color:var(--amber);">View Appeal</button>
          <button class="btn btn-danger btn-sm" onclick="closeReq(${r.id})">Close Request</button>` : ''}
        ${!isClosed ? `<button class="btn btn-danger btn-sm" onclick="deleteReq(${r.id})">Delete</button>` : ''}
      </div>
    </div>

    ${deadlineBanner}

    <div class="detail-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
      <div class="card">
        <div class="card-title">Notes</div>
        <p style="font-size:.9rem;color:var(--text-dim);white-space:pre-wrap;">${esc(r.notes)||'No notes.'}</p>
      </div>
      ${(isActive || isAppealed) ? `<div class="card">
        <div class="card-title">Deadline Info</div>
        <div class="form-info">
          <div class="info-label">Response Days</div>
          <div class="info-val">${r.response_days||20} business days</div>
          <div class="info-label" style="margin-top:10px;">Deadline Date</div>
          <div class="info-val">${fmtDate(r.deadline_date)||'—'}</div>
          ${r.secondary_contact_email ? `
          <div class="info-label" style="margin-top:10px;">2nd Contact Email</div>
          <div class="info-val"><a href="mailto:${esc(r.secondary_contact_email)}" style="color:var(--cyan);">${esc(r.secondary_contact_email)}</a></div>` : ''}
        </div>
      </div>` : '<div></div>'}
    </div>

    ${isAppealed && r.appeal_text ? `
    <div class="card" style="margin-bottom:16px;border-color:rgba(245,166,35,.3);">
      <div class="card-title" style="color:var(--amber);">⚖️ Appeal on File</div>
      <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:12px;">
        <div class="meta-chip"><strong>Type:</strong> ${esc(appealTypeLabel(r.appeal_type))}</div>
        <div class="meta-chip"><strong>Filed:</strong> ${fmtDateTime(r.appeal_saved_at)}</div>
        ${r.appeal_exemption ? `<div class="meta-chip"><strong>Exemption:</strong> ${esc(r.appeal_exemption)}</div>` : ''}
      </div>
      <div style="display:flex;gap:6px;">
        <button class="btn btn-ghost btn-sm" onclick="openAppealModal(${r.id})" style="border-color:var(--amber);color:var(--amber);">View / Edit Appeal</button>
        <button class="btn btn-ghost btn-sm" onclick="copyAppealText(${JSON.stringify(r.appeal_text).replace(/'/g,'&#39;')})">Copy Appeal</button>
      </div>
    </div>` : ''}

    <div class="card" style="margin-bottom:16px;">
      <div class="card-title" style="display:flex;align-items:center;justify-content:space-between;">
        <span style="font-size:.75rem;width:120px;">📁 Attachments</span>
        <label class="btn btn-ghost btn-sm" style="cursor:pointer;margin:0;padding:4px 8px;font-size:.7rem;width:80px;">
          ↑ Upload
          <input type="file" style="display:none;" onchange="uploadAttachment(${r.id}, this)">
        </label>
      </div>
      <div id="attachmentList-${r.id}">
        <div style="color:var(--text-dim);font-size:.85rem;padding:4px 0;">Loading…</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Action Log</div>
      ${logHtml}
    </div>`;

  // Load attachments after rendering
  loadAttachments(r.id);
}

// ─────────────────────────────────────────────────────────────
// Attachments
// ─────────────────────────────────────────────────────────────
function fmtBytes(bytes) {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes/1024).toFixed(1)} KB`;
  return `${(bytes/(1024*1024)).toFixed(1)} MB`;
}

async function loadAttachments(reqId) {
  const el = document.getElementById(`attachmentList-${reqId}`);
  if (!el) return;
  const { status, data } = await api('GET', `/api/requests/${reqId}/attachments`);
  if (status !== 200 || !Array.isArray(data)) {
    el.innerHTML = `<div style="color:var(--text-dim);font-size:.85rem;">No attachments yet.</div>`;
    return;
  }
  if (!data.length) {
    el.innerHTML = `<div style="color:var(--text-dim);font-size:.85rem;">No attachments yet.</div>`;
    return;
  }
  el.innerHTML = data.map(a => `
    <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);">
      <span style="font-size:1.2rem;">${fileIcon(a.original_name)}</span>
      <div style="flex:1;min-width:0;">
        <div style="font-size:.88rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
          ${esc(a.original_name)}
        </div>
        <div style="font-size:.75rem;color:var(--text-dim);">
          ${fmtBytes(a.file_size)} · ${fmtDateTime(a.uploaded_at)}
          ${a.label ? ` · <em>${esc(a.label)}</em>` : ''}
        </div>
      </div>
      <a href="/api/attachments/${a.id}/download"
         class="btn btn-ghost btn-sm" style="flex-shrink:0;">↓ Download</a>
      <button class="btn btn-ghost btn-sm" style="flex-shrink:0;color:var(--amber);"
              onclick="deleteAttachment(${a.id}, ${reqId})">×</button>
    </div>
  `).join('');
}

function fileIcon(name) {
  const ext = (name || '').split('.').pop().toLowerCase();
  if (['pdf'].includes(ext)) return '□';
  if (['jpg','jpeg','png','gif','webp','heic'].includes(ext)) return '▢';
  if (['doc','docx'].includes(ext)) return '▪';
  if (['xls','xlsx','csv'].includes(ext)) return '▫';
  if (['mp4','mov','avi','mkv'].includes(ext)) return '▸';
  if (['mp3','wav','m4a'].includes(ext)) return '♪';
  if (['zip','tar','gz'].includes(ext)) return '⬚';
  return '○';
}

async function uploadAttachment(reqId, input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 20 * 1024 * 1024) {
    toast('File exceeds 20MB limit', 'error'); return;
  }
  const formData = new FormData();
  formData.append('file', file);
  toast(`Uploading ${file.name}…`, '');
  try {
    const res = await fetch(`/api/requests/${reqId}/attachments`, {
      method: 'POST', body: formData
    });
    const data = await res.json();
    if (!res.ok) { toast(data.error || 'Upload failed', 'error'); return; }
    toast(`✓ ${file.name} uploaded`, 'success');
    input.value = '';
    await loadAttachments(reqId);
  } catch(e) {
    toast('Upload failed', 'error');
  }
}

async function deleteAttachment(attId, reqId) {
  if (!confirm('Delete this attachment? This cannot be undone.')) return;
  const { status, data } = await api('DELETE', `/api/attachments/${attId}`);
  if (status !== 200) { toast(data.error || 'Delete failed', 'error'); return; }
  toast('Attachment deleted', 'success');
  await loadAttachments(reqId);
}
async function openLetter(id) {
  pendingLetterId = id;
  const { data: r } = await api('GET', `/api/requests/${id}`);

  let text = r.letter_text;
  if (!text) {
    const { data: gen } = await api('GET', `/api/requests/${id}/generate-letter`);
    text = gen.letter_text || '';
  }

  document.getElementById('letterText').textContent = text;
  document.getElementById('letterModalSub').textContent =
    r.status === 'active'
      ? 'Letter already saved. You can copy it or download it as a Word doc.'
      : 'Edit the letter, then save it to move this request to Active.';

  // Show download button only if letter is already saved (active requests)
  document.getElementById('btnDownloadDocx').style.display =
    r.status === 'active' ? 'inline-flex' : 'none';

  // Only show FOIA.gov portal link for federal requests
  const portalLink = document.getElementById('foiaGovLink');
  if (portalLink) {
    portalLink.style.display = (r.jurisdiction === 'Federal') ? '' : 'none';
  }

  const overlay = document.getElementById('letterModal');
  overlay.classList.add('open');
  // Scroll modal content to top
  const modalEl = overlay.querySelector('.modal');
  if (modalEl) modalEl.scrollTop = 0;
}

async function downloadDocx() {
  if (!pendingLetterId) return;
  toast('Generating Word doc…', '');
  window.location.href = `/api/requests/${pendingLetterId}/download-docx`;
}

async function quickSetTurn(id, value) {
  const { status, data } = await api('POST', `/api/requests/${id}/update`, { turn: value });
  if (status !== 200) {
    toast(data.error || 'Update failed', 'error');
    return;
  }
  toast(`✓ Marked as "${value}"`, 'success');
  await refreshAllData();
  // Re-render the active table without full page nav
  await loadActiveRequests();
}

function closeLetter() {
  document.getElementById('letterModal').classList.remove('open');
  pendingLetterId = null;
}

function discardLetter() {
  if (!confirm('Discard this letter? The request will remain in New status.')) return;
  closeLetter();
}

function copyLetter() {
  const text = document.getElementById('letterText').innerText;
  navigator.clipboard.writeText(text).then(() => {
    const el = document.getElementById('copySuccess');
    el.style.display = 'inline';
    setTimeout(() => el.style.display = 'none', 2500);
  });
}

async function saveLetter() {
  if (!pendingLetterId) return;
  const text = document.getElementById('letterText').innerText;
  const { status, data } = await api('POST', `/api/requests/${pendingLetterId}/save-letter`, {
    letter_text: text
  });
  if (status !== 200) { toast(data.error || 'Save failed', 'error'); return; }
  toast(`✓ Letter saved — moved to Active. Deadline: ${fmtDate(data.deadline_date)}`, 'success');
  closeLetter();
  await refreshAllData();
  nav('active-requests');
}

// ─────────────────────────────────────────────────────────────
// Update Request modal
// ─────────────────────────────────────────────────────────────
async function openUpdateModal(id) {
  pendingUpdateId = id;
  const { data: r } = await api('GET', `/api/requests/${id}`);
  document.getElementById('updNotes').value    = r.notes || '';
  document.getElementById('updDeadline').value = r.deadline_date || '';
  document.getElementById('updTurn').value     = r.turn || 'My Turn';
  document.getElementById('updSecName').value  = r.secondary_contact_name || '';
  document.getElementById('updSecEmail').value = r.secondary_contact_email || '';
  document.getElementById('updateModal').classList.add('open');
}

function closeUpdateModal() {
  document.getElementById('updateModal').classList.remove('open');
  pendingUpdateId = null;
}

async function saveUpdate() {
  if (!pendingUpdateId) return;
  const payload = {
    notes:                   document.getElementById('updNotes').value,
    deadline_date:           document.getElementById('updDeadline').value || undefined,
    turn:                    document.getElementById('updTurn').value,
    secondary_contact_name:  document.getElementById('updSecName').value,
    secondary_contact_email: document.getElementById('updSecEmail').value,
  };
  const { status, data } = await api('POST', `/api/requests/${pendingUpdateId}/update`, payload);
  if (status !== 200) { toast(data.error || 'Update failed', 'error'); return; }
  toast('✓ Request updated', 'success');
  closeUpdateModal();
  await openDetail(pendingUpdateId);
  await refreshAllData();
}

// ─────────────────────────────────────────────────────────────
// Close / Delete
// ─────────────────────────────────────────────────────────────
async function closeReq(id) {
  if (!confirm('Mark this request as closed?')) return;
  const { status, data } = await api('POST', `/api/requests/${id}/close`, {});
  if (status !== 200) { toast(data.error || 'Failed', 'error'); return; }
  toast('✓ Request closed', 'success');
  await refreshAllData();
  nav('closed-requests');
}

async function deleteReq(id) {
  if (!confirm('Permanently delete this request? This cannot be undone.')) return;
  const { status, data } = await api('DELETE', `/api/requests/${id}`);
  if (status !== 200) { toast(data.error || 'Failed', 'error'); return; }
  toast('Request deleted', '');
  await refreshAllData();
  nav('all-requests');
}

// ─────────────────────────────────────────────────────────────
// Helpers
// ─────────────────────────────────────────────────────────────
function esc(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

function fmtDate(d) {
  if (!d) return '—';
  try {
    return new Date(d + 'T12:00:00').toLocaleDateString('en-US',
      { month: 'short', day: 'numeric', year: 'numeric' });
  } catch { return d; }
}

function fmtDateTime(d) {
  if (!d) return '—';
  try {
    return new Date(d).toLocaleString('en-US',
      { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
  } catch { return d; }
}

function statusBadge(r) {
  if (r.status === 'new')      return `<span class="badge badge-new">New</span>`;
  if (r.status === 'closed')   return `<span class="badge badge-closed">Closed</span>`;
  if (r.status === 'appealed') return `<span class="badge badge-appealed">Appealed</span>`;
  if (r.status === 'active') {
    if (r.days_since_deadline > 0)
      return `<span class="badge badge-overdue">Overdue</span>`;
    return `<span class="badge badge-active">Active</span>`;
  }
  return `<span class="badge badge-new">${esc(r.status)}</span>`;
}

// ─────────────────────────────────────────────────────────────
// Appeal modal
// ─────────────────────────────────────────────────────────────
let pendingAppealId = null;

const APPEAL_TYPE_LABELS = {
  constructive_denial: 'No Response / Constructive Denial',
  improper_exemption:  'Improper Exemption Claimed',
  inadequate_search:   'Inadequate Search',
  fee_dispute:         'Fee Dispute',
};

function appealTypeLabel(type) {
  return APPEAL_TYPE_LABELS[type] || type || '—';
}

function onAppealTypeChange() {
  const t = document.getElementById('appealType').value;
  document.getElementById('exemptionRow').style.display =
    t === 'improper_exemption' ? '' : 'none';
  regenerateAppeal();
}

async function openAppealModal(id) {
  pendingAppealId = id;
  const { data: r } = await api('GET', `/api/requests/${id}`);

  // Pre-select type and exemption if appeal already saved
  if (r.appeal_type) {
    document.getElementById('appealType').value = r.appeal_type;
    document.getElementById('appealExemption').value = r.appeal_exemption || '';
    document.getElementById('exemptionRow').style.display =
      r.appeal_type === 'improper_exemption' ? '' : 'none';
  } else {
    document.getElementById('appealType').value = 'constructive_denial';
    document.getElementById('exemptionRow').style.display = 'none';
  }

  // Load saved appeal text or generate fresh
  if (r.appeal_text) {
    document.getElementById('appealText').textContent = r.appeal_text;
  } else {
    await regenerateAppeal();
  }

  const isState = ['State', 'Local', 'University'].includes(r.agency_type);
  document.getElementById('appealModalSub').textContent = isState
    ? `${r.foia_number} — State/Local appeal`
    : `${r.foia_number} — Federal appeal to DOJ Office of Information Policy`;
  document.getElementById('appealModal').classList.add('open');
}

async function regenerateAppeal() {
  if (!pendingAppealId) return;
  const type      = document.getElementById('appealType').value;
  const exemption = document.getElementById('appealExemption').value;
  const params    = new URLSearchParams({ type, exemption });
  const { data }  = await api('GET', `/api/requests/${pendingAppealId}/generate-appeal?${params}`);
  document.getElementById('appealText').textContent = data.appeal_text || '';
}

function closeAppealModal() {
  document.getElementById('appealModal').classList.remove('open');
  pendingAppealId = null;
}

function copyAppeal() {
  const text = document.getElementById('appealText').innerText;
  navigator.clipboard.writeText(text).then(() => {
    const el = document.getElementById('appealCopySuccess');
    el.style.display = 'inline';
    setTimeout(() => el.style.display = 'none', 2500);
  });
}

function copyAppealText(text) {
  navigator.clipboard.writeText(text).then(() => toast('✓ Appeal copied', 'success'));
}

async function saveAppeal() {
  if (!pendingAppealId) return;
  const appeal_type = document.getElementById('appealType').value;
  const appeal_text = document.getElementById('appealText').innerText;
  const exemption   = document.getElementById('appealExemption').value;

  const { status, data } = await api('POST', `/api/requests/${pendingAppealId}/save-appeal`, {
    appeal_type, appeal_text, exemption
  });
  if (status !== 200) { toast(data.error || 'Save failed', 'error'); return; }

  toast('✓ Appeal saved — request marked as Appealed', 'success');
  closeAppealModal();
  await refreshAllData();
  await openDetail(pendingAppealId);
}
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.getElementById('letterModal').classList.remove('open');
    document.getElementById('updateModal').classList.remove('open');
    document.getElementById('appealModal').classList.remove('open');
    closeSidebar();
  }
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    if (document.getElementById('letterModal').classList.contains('open')) saveLetter();
    if (document.getElementById('updateModal').classList.contains('open')) saveUpdate();
    if (document.getElementById('appealModal').classList.contains('open')) saveAppeal();
  }
});

// Enter key on auth inputs
['loginUser','loginPass'].forEach(id => {
  document.getElementById(id).addEventListener('keydown', e => {
    if (e.key === 'Enter') doLogin();
  });
});
['regUser','regEmail','regPass'].forEach(id => {
  document.getElementById(id).addEventListener('keydown', e => {
    if (e.key === 'Enter') doRegister();
  });
});

// ─────────────────────────────────────────────────────────────
// Boot — check if already logged in
// ─────────────────────────────────────────────────────────────
// Apply saved theme immediately to avoid flash on reload
(function() {
  const t = localStorage.getItem('foiaio-theme') || 'dark';
  if (t === 'light') document.documentElement.setAttribute('data-theme', 'light');
})();

window.scrollTo(0, 0);


// ── Law Enforcement Modal ────────────────────────────────────
let leCurrentOffset = 0;
let leCurrentTotal = 0;
const lePageSize = 50;

async function openLawEnforcementModal() {
  document.getElementById('lawEnforcementModal').classList.add('open');
  
  // Load states and types for filters
  const [statesRes, typesRes] = await Promise.all([
    api('GET', '/api/law-enforcement/states'),
    api('GET', '/api/law-enforcement/types')
  ]);
  
  if (statesRes.data?.states) {
    const sel = document.getElementById('leStateFilter');
    sel.innerHTML = '<option value="">All States</option>';
    statesRes.data.states.forEach(s => {
      sel.innerHTML += `<option value="${s.state_abbr}">${s.state_abbr} (${s.count.toLocaleString()})</option>`;
    });
  }
  
  if (typesRes.data?.types) {
    const sel = document.getElementById('leTypeFilter');
    sel.innerHTML = '<option value="">All Types</option>';
    typesRes.data.types.forEach(t => {
      const name = t.agency_type || 'Other';
      sel.innerHTML += `<option value="${name}">${name} (${t.count.toLocaleString()})</option>`;
    });
  }
  
  // Auto-search to show some results
  searchLawEnforcement();
}

// ─────────────────────────────────────────────────────────────
// Admin: Invite Codes
// ─────────────────────────────────────────────────────────────
async function adminLoadCodes() {
  const { status, data } = await api('GET', '/api/admin/invite-codes');
  const el = document.getElementById('adminCodesList');
  if (status === 403) {
    el.innerHTML = '<div style="color:var(--red);font-size:.85rem;">Access denied.</div>';
    return;
  }
  if (!data.length) {
    el.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-dim);font-size:.85rem;">No codes yet.</div>';
    return;
  }
  el.innerHTML = data.map(c => `
    <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);">
      <span style="font-family:monospace;font-size:.88rem;">${escapeHtml(c.code)}</span>
      <span style="font-size:.75rem;padding:2px 8px;border-radius:4px;${c.used ? 'background:var(--bg3);color:var(--text-dim);' : 'background:rgba(0,200,150,.1);color:var(--green);'}">${c.used ? 'Used' : 'Available'}</span>
    </div>
  `).join('');
}

async function adminGenerateCodes() {
  const count = parseInt(document.getElementById('adminCodeCount').value) || 1;
  const { status, data } = await api('POST', '/api/admin/invite-codes', { count });
  if (status === 403) { showToast('Access denied'); return; }
  document.getElementById('adminNewCodesList').innerHTML = data.created.join('<br>');
  document.getElementById('adminNewCodes').style.display = '';
  adminLoadCodes();
}

function helpTab(tab) {
  ['about', 'start', 'support'].forEach(t => {
    document.getElementById(`helpPane-${t}`).style.display = t === tab ? '' : 'none';
    const btn = document.getElementById(`helpTab-${t}`);
    btn.style.borderBottom = t === tab ? '2px solid var(--cyan)' : '2px solid transparent';
    btn.style.color = t === tab ? 'var(--text)' : '';
  });
}

function closeLawEnforcementModal(e) {
  if (e && e.target.id !== 'lawEnforcementModal') return;
  document.getElementById('lawEnforcementModal').classList.remove('open');
}

async function selectLEAgency(a) {
  document.getElementById('lawEnforcementModal').classList.remove('open');

  // Navigate to new request page (this calls initNewRequestForm internally)
  await nav('new-request');

  // Set jurisdiction to State
  const typeEl = document.getElementById('nrType');
  typeEl.value = 'State';
  onTypeChange();

  // Set state and trigger law info load
  await loadStatesDropdown();
  const stateEl = document.getElementById('nrState');
  stateEl.value = a.state_abbr;
  await onStateChange();

  // Fill agency name and officer if available
  document.getElementById('nrStateAgency').value = a.agency_name + (a.agency_unit ? ` — ${a.agency_unit}` : '');
  if (a.foia_officer) {
    document.getElementById('nrStateOfficer').value = a.foia_officer;
  }
}

async function searchLawEnforcement() {
  leCurrentOffset = 0;
  await loadLawEnforcementResults();
}

async function loadLawEnforcementPage(dir) {
  if (dir === 'next') leCurrentOffset += lePageSize;
  else if (dir === 'prev') leCurrentOffset = Math.max(0, leCurrentOffset - lePageSize);
  await loadLawEnforcementResults();
}

async function loadLawEnforcementResults() {
  const search = document.getElementById('leSearch').value.trim();
  const state = document.getElementById('leStateFilter').value;
  const type = document.getElementById('leTypeFilter').value;
  
  const params = new URLSearchParams({
    limit: lePageSize,
    offset: leCurrentOffset
  });
  if (search) params.set('q', search);
  if (state) params.set('state', state);
  if (type) params.set('type', type);
  
  const { data } = await api('GET', `/api/law-enforcement/agencies?${params}`);
  
  if (!data || !data.results) {
    document.getElementById('leResults').innerHTML = 
      '<div style="text-align:center;padding:40px;color:var(--text-dim);">Error loading results</div>';
    return;
  }
  
  leCurrentTotal = data.total || 0;

  // Update subtitle with real total when unfiltered
  if (!search && !state && !type) {
    const subtitle = document.getElementById('leSubtitle');
    if (subtitle) subtitle.textContent = `${leCurrentTotal.toLocaleString()} agencies • FBI 2024 data`;
  }

  // Update stats
  document.getElementById('leStats').textContent =
    `Showing ${data.results.length} of ${leCurrentTotal.toLocaleString()} agencies`;
  
  // Render results
  const html = data.results.map(a => `
    <div onclick="selectLEAgency(${JSON.stringify(a).replace(/"/g, '&quot;')})"
         style="padding:12px 8px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;"
         onmouseenter="this.style.background='var(--bg3)'" onmouseleave="this.style.background=''">
      <div style="font-weight:500;word-break:break-word;">${escapeHtml(a.agency_name)}${a.agency_unit ? ` — ${escapeHtml(a.agency_unit)}` : ''}</div>
      <div style="font-size:.8rem;color:var(--text-dim);margin-top:3px;word-break:break-word;">
        ${a.agency_type || 'Unknown Type'} • ${a.state_abbr}${a.city_name ? ` • ${escapeHtml(a.city_name)}` : ''}${a.county_name ? ` • ${a.county_name.toLowerCase().replace(/\b\w/g, c => c.toUpperCase())} County` : ''}${a.ori ? ` • <span style="font-family:monospace;">ORI: ${escapeHtml(a.ori)}</span>` : ''}
      </div>
      <div style="font-size:.8rem;color:var(--text-dim);margin-top:4px;word-break:break-word;">📍 ${a.foia_address ? escapeHtml(a.foia_address) : '<span style="font-style:italic;">Call agency for mailing address</span>'}</div>
      ${a.foia_phone ? `<div style="font-size:.8rem;color:var(--text-dim);margin-top:2px;">📞 ${escapeHtml(a.foia_phone)}</div>` : ''}
      ${a.foia_portal_url ? `<div style="margin-top:4px;" onclick="event.stopPropagation()"><a href="${escapeHtml(a.foia_portal_url)}" target="_blank" rel="noopener" style="font-size:.8rem;color:var(--cyan);word-break:break-all;">🔗 Records Portal</a></div>` : ''}
    </div>
  `).join('');
  
  document.getElementById('leResults').innerHTML = html || 
    '<div style="text-align:center;padding:40px;color:var(--text-dim);">No agencies found</div>';
  
  // Update pagination
  const hasResults = data.results.length > 0;
  document.getElementById('lePagination').style.display = hasResults ? 'block' : 'none';
  if (hasResults) {
    const start = leCurrentOffset + 1;
    const end = Math.min(leCurrentOffset + data.results.length, leCurrentTotal);
    document.getElementById('lePageInfo').textContent = `${start}–${end} of ${leCurrentTotal.toLocaleString()}`;
    document.getElementById('lePrevBtn').disabled = leCurrentOffset === 0;
    document.getElementById('leNextBtn').disabled = end >= leCurrentTotal;
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

(async () => {
  const { data } = await api('GET', '/api/auth/me');
  if (data.authenticated) {
    bootApp(data.username, data.subscription_status);
  }
})();
</script>

<!-- ── Federal Agency Directory Modal ──────────────────────── -->
<div class="modal-overlay" id="agencyDirModal" onclick="closeAgencyModal(event)">
  <div class="modal" style="max-width:860px;width:95%;">
    <div class="modal-header">
      <div>
        <h2>⚖︎ Federal FOIA Agency Directory</h2>
        <div style="font-size:.82rem;color:var(--text-dim);margin-top:2px;">Federal agency FOIA contacts</div>
      </div>
      <button class="modal-close" onclick="closeAgencyModal()">✕</button>
    </div>
    <div class="modal-body">
      <input id="agencyDirSearch" type="text" placeholder="Search agencies..."
        oninput="filterAgencyDir()"
        style="width:100%;padding:8px 12px;margin-bottom:14px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:.9rem;box-sizing:border-box;">
      <div class="table-wrap" style="max-height:55dvh;overflow-y:auto;">
        <table style="font-size:.7rem;">
          <thead><tr><th>Agency</th><th>Code</th><th>Email</th><th class="hide-mobile">Phone</th><th></th></tr></thead>
          <tbody id="agencyDirBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>


<!-- ── Law Enforcement Agency Directory Modal ──────────────── -->
<div class="modal-overlay" id="lawEnforcementModal" onclick="closeLawEnforcementModal(event)">
  <div class="modal" style="max-width:960px;width:95%;">
    <div class="modal-header">
      <div>
        <h2>✭ State & Local Agency Directory</h2>
        <div id="leSubtitle" style="font-size:.82rem;color:var(--text-dim);margin-top:2px;">17,979 agencies • FBI 2024 data</div>
      </div>
      <button class="modal-close" onclick="closeLawEnforcementModal()">✕</button>
    </div>
    <div class="modal-body">
      <div class="filter-row" style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;">
        <input id="leSearch" type="text" placeholder="Search by name or county..."
               style="width:100%;" onkeyup="searchLawEnforcement()">
        <div style="display:flex;gap:8px;">
          <select id="leStateFilter" onchange="searchLawEnforcement()" style="flex:1;min-width:0;">
            <option value="">All States</option>
          </select>
          <select id="leTypeFilter" onchange="searchLawEnforcement()" style="flex:1;min-width:0;">
            <option value="">All Types</option>
          </select>
        </div>
      </div>
      
      <div id="leStats" style="font-size:.85rem;color:var(--text-dim);margin-bottom:12px;"></div>
      
      <div id="leResults" style="max-height:45dvh;overflow-y:auto;">
        <div style="text-align:center;padding:40px;color:var(--text-dim);">
          Enter search criteria or select filters
        </div>
      </div>
      
      <div id="lePagination" style="margin-top:16px;text-align:center;display:none;">
        <button onclick="loadLawEnforcementPage('prev')" id="lePrevBtn" class="btn btn-sm">← Prev</button>
        <span id="lePageInfo" style="margin:0 16px;"></span>
        <button onclick="loadLawEnforcementPage('next')" id="leNextBtn" class="btn btn-sm">Next →</button>
      </div>
    </div>
  </div>
</div>

<!-- ── State Laws Modal ──────────────────────────────────────── -->
<div class="modal-overlay" id="stateLawsModal" onclick="closeStateLawsModal(event)">
  <div class="modal" style="max-width:900px;width:95%;">
    <div class="modal-header">
      <div>
        <h2>⚖︎ State Public Records Laws</h2>
        <div style="font-size:.82rem;color:var(--text-dim);margin-top:2px;">All 50 states + DC</div>
      </div>
      <button class="modal-close" onclick="closeStateLawsModal()">✕</button>
    </div>
    <div class="modal-body">
      <input id="stateLawsSearch" type="text" placeholder="Search states..."
        oninput="filterStateLaws()"
        style="width:100%;padding:8px 12px;margin-bottom:14px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:.9rem;box-sizing:border-box;">
      <div class="table-wrap" style="max-height:55dvh;overflow-y:auto;">
        <table>
          <thead><tr><th>State</th><th>Code</th><th>Law Name</th><th>Citation</th><th>Response Days</th><th>Appeal Days</th><th>Notes</th><th></th></tr></thead>
          <tbody id="stateLawsBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
async function openAgencyModal() {
  document.getElementById('agencyDirModal').classList.add('open');
  document.getElementById('agencyDirSearch').value = '';
  await loadAgencyDir();
  filterAgencyDir();
  document.getElementById('agencyDirSearch').focus();
}
function closeAgencyModal(e) {
  if (!e || e.target === document.getElementById('agencyDirModal'))
    document.getElementById('agencyDirModal').classList.remove('open');
}
function filterAgencyDir() {
  const q = document.getElementById('agencyDirSearch').value.toLowerCase();
  document.querySelectorAll('#agencyDirBody tr').forEach(tr => {
    tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
}
let stateLawsLoaded = false;
async function openStateLawsModal() {
  document.getElementById('stateLawsModal').classList.add('open');
  document.getElementById('stateLawsSearch').value = '';
  if (!stateLawsLoaded) { await loadStateLaws(); stateLawsLoaded = true; }
  filterStateLaws();
  document.getElementById('stateLawsSearch').focus();
}
function closeStateLawsModal(e) {
  if (!e || e.target === document.getElementById('stateLawsModal'))
    document.getElementById('stateLawsModal').classList.remove('open');
}
function filterStateLaws() {
  const q = document.getElementById('stateLawsSearch').value.toLowerCase();
  document.querySelectorAll('#stateLawsBody tr').forEach(tr => {
    tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
}
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeAgencyModal(); closeStateLawsModal(); }
});

function copyRef(btn, text, label) {
  navigator.clipboard.writeText(text).then(() => {
    const orig = btn.textContent;
    btn.textContent = '✓ ' + label;
    btn.classList.add('copied');
    setTimeout(() => {
      btn.textContent = orig;
      btn.classList.remove('copied');
    }, 2000);
  });
}
</script>
</body>
</html>